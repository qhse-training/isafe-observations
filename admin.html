<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å i-SAFE - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* (–°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –¢–ï–ú–ò –ñ–ï, –ü–û–ö–ê –ù–ï –¢–†–û–ì–ê–ï–ú) */
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body {
      background-color: #f5f7fa;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding-bottom: 30px;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
    .tabs {
      display: flex;
      background: #ecf0f1;
      border-bottom: 2px solid #3498db;
    }
    .tab-btn {
      padding: 15px 30px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #7f8c8d;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    .tab-btn:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }
    .tab-btn.active {
      color: #3498db;
      border-bottom: 3px solid #3498db;
      background-color: white;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ) */
    .controls {
      padding: 15px 20px;
      background: #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .controls button:hover {
      background-color: #2980b9;
    }
    .status-info {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-online {
      background-color: #2ecc71;
    }
    .status-offline {
      background-color: #e74c3c;
    }
    .status-loading {
      background-color: #f39c12;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .filter-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-controls select,
    .filter-controls input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .charts-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 20px;
    }
    .chart-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .chart-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #2c3e50;
      text-align: center;
      font-weight: 600;
    }
    .chart-wrapper {
      position: relative;
      height: 300px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #2c3e50;
      margin: 10px 0;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 0.9rem;
    }
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #3498db;
      font-style: italic;
    }
    .error-message {
      text-align: center;
      padding: 40px;
      color: #e74c3c;
      font-style: italic;
    }
    .period-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .period-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .period-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞ */
    .register-container {
      padding: 20px;
    }
    .register-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 8px;
    }
    .search-box {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    .register-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .register-table th {
      background-color: #2c3e50;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    .register-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    .register-table tr:hover {
      background-color: #f9f9f9;
    }
    .register-table tr:last-child td {
      border-bottom: none;
    }
    .observation-details {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .observation-details.expanded {
      white-space: normal;
      overflow: visible;
    }
    .details-btn {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      padding: 0;
      font-size: 12px;
    }
    .export-btn {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .export-btn:hover {
      background-color: #219653;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .page-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
    .code-search {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .code-search-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    .code-display {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      background: #f8f9fa;
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <!-- –ü–∞—Ä–æ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ -->
  <script>
    const ADMIN_PASSWORD = "April2025!";
    let isAuthenticated = sessionStorage.getItem('isafe_admin') === 'true';
    
    if (!isAuthenticated) {
      const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:");
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('isafe_admin', 'true');
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.");
        window.location.href = 'index.html';
      }
    }
  </script>

  <div class="container">
    <header>
      <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å i-SAFE - –ù–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º–∏</h1>
    </header>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="statistics">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button class="tab-btn" data-tab="register">üìã –†–µ–≥–∏—Å—Ç—Ä –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</button>
      <button class="tab-btn" data-tab="export">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="statistics-tab" class="tab-content active">
      <div class="controls">
        <div style="display: flex; gap: 10px; align-items: center;">
          <button id="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
          <div class="status-info">
            <span class="status-dot status-online" id="status-dot"></span>
            <span id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
          </div>
        </div>
        
        <div class="filter-controls">
          <div class="period-selector">
            <button class="period-btn active" data-period="all">–í—Å–µ –≤—Ä–µ–º—è</button>
            <button class="period-btn" data-period="month">–ó–∞ –º–µ—Å—è—Ü</button>
            <button class="period-btn" data-period="week">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
            <button class="period-btn" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
          </div>
          <select id="filter-company">
            <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
          </select>
          <select id="filter-area">
            <option value="">–í—Å–µ –∑–æ–Ω—ã</option>
          </select>
          <input type="date" id="filter-date-from" placeholder="–° –¥–∞—Ç—ã">
          <input type="date" id="filter-date-to" placeholder="–ü–æ –¥–∞—Ç—É">
          <button id="reset-filters" style="background-color: #95a5a6;">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        
        <div>
          <button id="back-to-form-btn" style="background-color: #27ae60;">‚Üê –ö —Ñ–æ—Ä–º–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</button>
        </div>
      </div>

      <!-- –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="summary-stats" id="summary-stats">
        <div class="stat-card">
          <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</div>
          <div class="stat-value" id="total-observations">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</div>
          <div class="stat-value" id="unsafe-conditions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
          <div class="stat-value" id="unsafe-actions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
          <div class="stat-value" id="work-stopped">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏</div>
          <div class="stat-value" id="unique-observers">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
          <div class="stat-value" id="avg-per-day">0</div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <div class="charts-container" id="charts-container">
        <div class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ -->
    <div id="register-tab" class="tab-content">
      <div class="register-container">
        <div class="register-controls">
          <div style="display: flex; gap: 15px; align-items: center;">
            <div>
              <input type="text" id="search-input" class="search-box" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—é, –∫–æ–º–ø–∞–Ω–∏–∏, –∑–æ–Ω–µ...">
              <button id="search-btn" style="margin-left: 10px;">üîç –ü–æ–∏—Å–∫</button>
            </div>
            <div class="code-search">
              <input type="text" id="search-code-input" class="code-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É...">
              <button id="search-code-btn">üîé –ù–∞–π—Ç–∏ –∫–æ–¥</button>
            </div>
          </div>
          <div>
            <button id="export-excel-btn" class="export-btn">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
          </div>
        </div>

        <div id="register-table-container">
          <table class="register-table">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ö–æ–¥</th>
                <th>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</th>
                <th>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è</th>
                <th>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è</th>
                <th>–ó–æ–Ω–∞</th>
                <th>–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</th>
                <th>–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—Ç—ã</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="register-table-body">
              <tr>
                <td colspan="9" style="text-align: center; padding: 40px;">
                  <div class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination" id="pagination">
          <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div id="export-tab" class="tab-content">
      <div style="padding: 40px; text-align: center;">
        <h2>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p style="margin-bottom: 30px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</p>
        
        <div style="max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 30px; border-radius: 10px;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:</label>
            <div style="display: flex; gap: 15px; justify-content: center;">
              <button id="export-excel-full" class="export-btn" style="background-color: #27ae60;">üìä Excel (–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</button>
              <button id="export-csv" class="export-btn" style="background-color: #3498db;">üìà CSV (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)</button>
              <button id="export-pdf" class="export-btn" style="background-color: #e74c3c;">üìÑ PDF (–æ—Ç—á–µ—Ç)</button>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">–ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö:</label>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <input type="date" id="export-date-from" style="padding: 8px;">
              <span>–ø–æ</span>
              <input type="date" id="export-date-to" style="padding: 8px;">
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏–π:</label>
            <select id="export-type" style="padding: 8px; width: 200px;">
              <option value="all">–í—Å–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</option>
              <option value="unsafe-condition">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</option>
              <option value="unsafe-action">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
            </select>
          </div>
          
          <button id="start-export" style="background-color: #9b59b6; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px;">
            üöÄ –ù–∞—á–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –Ω–∞–±–ª—é–¥–µ–Ω–∏—è -->
  <div id="observation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 10px; padding: 30px; position: relative;">
      <button id="close-modal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">√ó</button>
      <h2 style="margin-top: 0; color: #2c3e50;">–î–µ—Ç–∞–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h2>
      <div id="modal-content">
        <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </div>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCpI00DhnV2AqrVxE7eJ5nLyo7icFobLoU",
      authDomain: "i-safe-8aff1.firebaseapp.com",
      projectId: "i-safe-8aff1",
      storageBucket: "i-safe-8aff1.firebasestorage.app",
      messagingSenderId: "721183035804",
      appId: "1:721183035804:web:f81eba42fe1f272c1f3859",
      measurementId: "G-5737V4DSJJ"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", async function () {
      // ========== –û–ë–©–ò–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
      let allObservations = [];
      let currentCharts = [];
      let selectedPeriod = 'all';
      let currentPage = 1;
      const itemsPerPage = 20;
      
      // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò ==========
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.dataset.tab;
          
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
          button.classList.add('active');
          document.getElementById(`${tabId}-tab`).classList.add('active');
          
          // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          if (tabId === 'register') {
            loadRegisterData();
          }
        });
      });
      
      // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò ==========
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      function updateConnectionStatus(isLoading = false) {
        const isOnline = navigator.onLine;
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        if (isLoading) {
          statusDot.className = 'status-dot status-loading';
          statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
        } else if (isOnline) {
          statusDot.className = 'status-dot status-online';
          statusText.textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase';
        } else {
          statusDot.className = 'status-dot status-offline';
          statusText.textContent = '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º (–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)';
        }
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
      async function loadObservationsFromFirebase() {
        try {
          updateConnectionStatus(true);
          
          const querySnapshot = await db.collection('observations')
            .orderBy('createdAt', 'desc')
            .get();
          
          const observations = [];
          const companies = new Set();
          const areas = new Set();
          
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            observations.push({
              id: doc.id,
              ...data,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
              observationDate: data.observationDateTime ? new Date(data.observationDateTime) : (data.createdAt ? data.createdAt.toDate() : new Date())
            });
            
            if (data.companyObserver) companies.add(data.companyObserver);
            if (data.companyObserved) companies.add(data.companyObserved);
            if (data.areaText) areas.add(data.areaText);
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
          updateFilterOptions(companies, areas);
          
          updateConnectionStatus(false);
          return observations;
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
          return [];
        }
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
      function loadObservationsFromLocalStorage() {
        const localData = JSON.parse(localStorage.getItem('hseObservations') || '[]');
        const companies = new Set();
        const areas = new Set();
        
        const observations = localData.map(item => {
          if (item.companyObserver) companies.add(item.companyObserver);
          if (item.companyObserved) companies.add(item.companyObserved);
          if (item.areaText) areas.add(item.areaText);
          
          return {
            ...item,
            observationDate: item.observationDateTime ? new Date(item.observationDateTime) : 
                            (item.savedAt ? new Date(item.savedAt) : new Date())
          };
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        updateFilterOptions(companies, areas);
        
        return observations;
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function updateFilterOptions(companies, areas) {
        const filterCompany = document.getElementById('filter-company');
        const filterArea = document.getElementById('filter-area');
        
        // –ö–æ–º–ø–∞–Ω–∏–∏
        filterCompany.innerHTML = '<option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>';
        companies.forEach(company => {
          if (company) {
            const option = document.createElement('option');
            option.value = company;
            option.textContent = company;
            filterCompany.appendChild(option);
          }
        });
        
        // –ó–æ–Ω—ã
        filterArea.innerHTML = '<option value="">–í—Å–µ –∑–æ–Ω—ã</option>';
        areas.forEach(area => {
          if (area) {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            filterArea.appendChild(option);
          }
        });
      }
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–µ—Ä–∏–æ–¥–∞
      function filterObservations(observations) {
        const companyFilter = document.getElementById('filter-company').value;
        const areaFilter = document.getElementById('filter-area').value;
        const dateFrom = document.getElementById('filter-date-from').value ? new Date(document.getElementById('filter-date-from').value) : null;
        const dateTo = document.getElementById('filter-date-to').value ? new Date(document.getElementById('filter-date-to').value) : null;
        
        let filtered = observations.filter(item => {
          // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
          if (companyFilter && 
              item.companyObserver !== companyFilter && 
              item.companyObserved !== companyFilter) {
            return false;
          }
          
          // –§–∏–ª—å—Ç—Ä –ø–æ –∑–æ–Ω–µ
          if (areaFilter && item.areaText !== areaFilter && item.area !== areaFilter) {
            return false;
          }
          
          // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
          const itemDate = item.observationDate;
          
          if (dateFrom && itemDate < dateFrom) {
            return false;
          }
          
          if (dateTo) {
            const dateToPlusOne = new Date(dateTo);
            dateToPlusOne.setDate(dateToPlusOne.getDate() + 1);
            
            if (itemDate >= dateToPlusOne) {
              return false;
            }
          }
          
          return true;
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–∏–æ–¥
        filtered = applyPeriodFilter(filtered, selectedPeriod);
        
        return filtered;
      }
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É
      function applyPeriodFilter(observations, period) {
        if (period === 'all') return observations;
        
        const now = new Date();
        let startDate = new Date();
        
        switch (period) {
          case 'today':
            startDate.setHours(0, 0, 0, 0);
            break;
          case 'week':
            startDate.setDate(now.getDate() - 7);
            break;
          case 'month':
            startDate.setMonth(now.getMonth() - 1);
            break;
        }
        
        return observations.filter(item => {
          return item.observationDate >= startDate;
        });
      }
      
      // –†–∞—Å—á–µ—Ç —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      function calculateSummaryStats(observations) {
        const total = observations.length;
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
        const unsafeConditions = observations.filter(item => 
          item.typeObservation === 'unsafe-condition' || 
          item.typeObservationText === '–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ'
        ).length;
        
        const unsafeActions = observations.filter(item => 
          item.typeObservation === 'unsafe-action' || 
          item.typeObservationText === '–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ'
        ).length;
        
        // –†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
        const workStopped = observations.filter(item => 
          item.swa === '–î–∞' || item.swa === true
        ).length;
        
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
        const uniqueObservers = new Set(observations.map(item => item.name)).size;
        
        // –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å
        const dates = observations.map(item => {
          const date = item.observationDate;
          return date.toISOString().split('T')[0];
        });
        const uniqueDates = new Set(dates).size;
        const avgPerDay = uniqueDates > 0 ? (total / uniqueDates).toFixed(1) : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-observations').textContent = total;
        document.getElementById('unsafe-conditions').textContent = unsafeConditions;
        document.getElementById('unsafe-actions').textContent = unsafeActions;
        document.getElementById('work-stopped').textContent = workStopped;
        document.getElementById('unique-observers').textContent = uniqueObservers;
        document.getElementById('avg-per-day').textContent = avgPerDay;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
      function createChart(ctxId, labelExtractor, title, type = "bar") {
        const ctx = document.getElementById(ctxId);
        if (!ctx) return null;
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
        const filteredObservations = filterObservations(allObservations);
        
        // –°—á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const counts = {};
        filteredObservations.forEach(item => {
          const label = labelExtractor(item);
          if (label) {
            if (Array.isArray(label)) {
              label.forEach(l => {
                counts[l] = (counts[l] || 0) + 1;
              });
            } else {
              counts[label] = (counts[label] || 0) + 1;
            }
          }
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (—É–±—ã–≤–∞–Ω–∏—é)
        const sortedLabels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
        const sortedCounts = sortedLabels.map(label => counts[label]);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const maxItems = 15;
        const displayLabels = sortedLabels.slice(0, maxItems);
        const displayCounts = sortedCounts.slice(0, maxItems);
        
        if (displayLabels.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type,
          data: {
            labels: displayLabels,
            datasets: [{
              label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
              data: displayCounts,
              backgroundColor: displayLabels.map((_, i) => {
                const hue = (i * 40) % 360;
                return `hsl(${hue}, 70%, 50%)`;
              }),
              borderColor: displayLabels.map((_, i) => {
                const hue = (i * 40) % 360;
                return `hsl(${hue}, 70%, 30%)`;
              }),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: title,
                font: { size: 16 }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const total = filteredObservations.length;
                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                    return `${context.label}: ${context.raw} (${percentage}%)`;
                  }
                }
              }
            },
            scales: type === 'bar' ? {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            } : {}
          }
        });
        
        return chart;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
      function createHazardFactorsChart() {
        const ctx = document.getElementById("hazardFactorsChart");
        if (!ctx) return null;
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const filteredObservations = filterObservations(allObservations);
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const groups = {
          "–§–∏–∑–∏—á–µ—Å–∫–∏–µ": [
            "–®—É–º","–í–∏–±—Ä–∞—Ü–∏—è","–†–∞–¥–∏–∞—Ü–∏—è","–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞","–†–∞–±–æ—Ç–∞ –Ω–∞ –≤—ã—Å–æ—Ç–µ",
            "–¢—è–∂—ë–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞","–†—É—á–Ω—ã–µ –∏ –ø–µ—Ä–µ–Ω–æ—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã","–ü–∞–¥–∞—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
            "–õ–µ—Ç—è—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã","–ü–æ–¥—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ, –°–ø–æ—Ç—ã–∫–∞–Ω–∏–µ","–ö—Ä—É—Ç—è—â–∏–µ—Å—è –∏ –≤—Ä–∞—â–∞—é—â–∏–µ—Å—è",
            "–≠–ª–µ–∫—Ç—Ä–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç","–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
          ],
          "–•–∏–º–∏—á–µ—Å–∫–∏–µ –∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": ["–•–∏–º–∏—á–µ—Å–∫–∞—è","–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è"],
          "–ü—Å–∏—Ö–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": ["–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä","–≠—Ä–≥–æ–Ω–æ–º–∏–∫–∞","–ü—Å–∏—Ö–æ—Ç—Ä–æ–ø–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞","–†—É—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ"],
          "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ": ["–°–ò–ó","–£–±–æ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞","–ó–∞–º–∫–Ω—É—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ","–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞","–ü–æ–∂–∞—Ä–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","–û—Å–≤–µ—â–µ–Ω–∏–µ"]
        };
        
        // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –≥—Ä—É–ø–ø–∞–º
        const groupCounts = {};
        Object.keys(groups).forEach(group => {
          groupCounts[group] = 0;
        });
        
        // –°—á–∏—Ç–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const factorCounts = {};
        Object.values(groups).flat().forEach(factor => factorCounts[factor] = 0);
        
        filteredObservations.forEach(item => {
          let hazardList = [];
          if (Array.isArray(item.typeHazard)) {
            hazardList = item.typeHazard;
          } else if (typeof item.typeHazard === "string" && item.typeHazard) {
            hazardList = item.typeHazard.split(",").map(h => h.trim());
          }
          
          hazardList.forEach(h => {
            if (factorCounts[h] !== undefined) {
              factorCounts[h]++;
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä—É–ø–ø—É
              for (const [group, factors] of Object.entries(groups)) {
                if (factors.includes(h)) {
                  groupCounts[group]++;
                  break;
                }
              }
            }
          });
        });
        
        // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const datasets = [];
        let colorIndex = 0;
        
        Object.entries(groups).forEach(([group, factors]) => {
          factors.forEach(factor => {
            if (factorCounts[factor] > 0) {
              datasets.push({
                label: factor,
                data: [
                  group === "–§–∏–∑–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–•–∏–º–∏—á–µ—Å–∫–∏–µ –∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–ü—Å–∏—Ö–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0
                ],
                backgroundColor: `hsl(${colorIndex * 30 % 360}, 70%, 50%)`
              });
              colorIndex++;
            }
          });
        });
        
        if (datasets.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type: "bar",
          data: {
            labels: Object.keys(groups),
            datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  boxWidth: 15,
                  font: { size: 11 }
                }
              },
              title: {
                display: true,
                text: "–û–ø–∞—Å–Ω—ã–µ –∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã",
                font: { size: 16 }
              }
            },
            scales: {
              x: {
                stacked: true,
                title: {
                  display: true,
                  text: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–æ–≤'
                }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π'
                }
              }
            }
          }
        });
        
        return chart;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –¥–Ω—è–º
      function createDailyChart() {
        const ctx = document.getElementById("dailyChart");
        if (!ctx) return null;
        
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const filteredObservations = filterObservations(allObservations);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
        const dailyCounts = {};
        filteredObservations.forEach(item => {
          const date = item.observationDate.toISOString().split('T')[0];
          const formattedDate = new Date(date).toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit'
          });
          dailyCounts[formattedDate] = (dailyCounts[formattedDate] || 0) + 1;
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        const sortedDates = Object.keys(dailyCounts).sort((a, b) => {
          return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
        });
        const sortedCounts = sortedDates.map(date => dailyCounts[date]);
        
        if (sortedDates.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type: "line",
          data: {
            labels: sortedDates,
            datasets: [{
              label: "–ù–∞–±–ª—é–¥–µ–Ω–∏–π –≤ –¥–µ–Ω—å",
              data: sortedCounts,
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "–î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –¥–Ω—è–º",
                font: { size: 16 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                }
              },
              x: {
                title: {
                  display: true,
                  text: '–î–∞—Ç–∞'
                }
              }
            }
          }
        });
        
        return chart;
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
      function updateAllCharts() {
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        const chartsContainer = document.getElementById('charts-container');
        chartsContainer.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartTemplates = [
          { id: 'observerCompanyChart', title: '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è', extractor: item => item.companyObserver },
          { id: 'observedCompanyChart', title: '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è', extractor: item => item.companyObserved },
          { id: 'locationChart', title: '–ú–µ—Å—Ç–æ (–ª–æ–∫–∞—Ü–∏—è)', extractor: item => item.areaText || item.area },
          { id: 'observationTypeChart', title: '–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è', extractor: item => item.typeObservationText || item.typeObservation },
          { id: 'stopWorkChart', title: '–û—Å—Ç–∞–Ω–æ–≤–∏–ª —Ä–∞–±–æ—Ç—É', extractor: item => item.swa },
          { id: 'reactionChart', title: '–†–µ–∞–∫—Ü–∏—è (–ß—Ç–æ —è –¥–µ–ª–∞—é?)', extractor: item => item.reaction ? item.reaction.substring(0, 50) + (item.reaction.length > 50 ? '...' : '') : null },
          { id: 'findingChart', title: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (–ß—Ç–æ —è –≤–∏–∂—É?)', extractor: item => item.detection ? item.detection.substring(0, 50) + (item.detection.length > 50 ? '...' : '') : null },
          { id: 'solutionChart', title: '–†–µ—à–µ–Ω–∏–µ (–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?)', extractor: item => item.solution ? item.solution.substring(0, 50) + (item.solution.length > 50 ? '...' : '') : null },
          { id: 'dailyChart', title: '–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º', type: 'line' }
        ];
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        chartTemplates.forEach((template, index) => {
          const chartCard = document.createElement('div');
          chartCard.className = 'chart-card';
          if (template.id === 'dailyChart') {
            chartCard.classList.add('full-width');
          }
          
          chartCard.innerHTML = `
            <div class="chart-title">${template.title}</div>
            <div class="chart-wrapper"><canvas id="${template.id}"></canvas></div>
          `;
          
          chartsContainer.appendChild(chartCard);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const hazardCard = document.createElement('div');
        hazardCard.className = 'chart-card full-width';
        hazardCard.innerHTML = `
          <div class="chart-title">–û–ø–∞—Å–Ω—ã–µ –∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</div>
          <div class="chart-wrapper"><canvas id="hazardFactorsChart"></canvas></div>
        `;
        chartsContainer.appendChild(hazardCard);
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        currentCharts = [];
        
        chartTemplates.forEach(template => {
          let chart;
          if (template.id === 'dailyChart') {
            chart = createDailyChart();
          } else if (template.id === 'hazardFactorsChart') {
            chart = createHazardFactorsChart();
          } else {
            chart = createChart(template.id, template.extractor, template.title, template.type);
          }
          if (chart) currentCharts.push(chart);
        });
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const hazardChart = createHazardFactorsChart();
        if (hazardChart) currentCharts.push(hazardChart);
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      async function refreshData() {
        try {
          updateConnectionStatus(true);
          
          if (navigator.onLine) {
            allObservations = await loadObservationsFromFirebase();
          } else {
            allObservations = loadObservationsFromLocalStorage();
          }
          
          calculateSummaryStats(allObservations);
          updateAllCharts();
          
          document.getElementById('status-text').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allObservations.length} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π`;
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
          const chartsContainer = document.getElementById('charts-container');
          chartsContainer.innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
          document.getElementById('status-text').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        } finally {
          updateConnectionStatus(false);
        }
      }
      
      // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–ì–ò–°–¢–†–ê ==========
      async function loadRegisterData(searchTerm = '', codeSearch = '') {
        const tableBody = document.getElementById('register-table-body');
        const pagination = document.getElementById('pagination');
        
        tableBody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">
              <div class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞...</div>
            </td>
          </tr>
        `;
        
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          if (allObservations.length === 0) {
            if (navigator.onLine) {
              allObservations = await loadObservationsFromFirebase();
            } else {
              allObservations = loadObservationsFromLocalStorage();
            }
          }
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
          let filteredObservations = allObservations;
          
          if (codeSearch) {
            // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const codeUpper = codeSearch.toUpperCase();
            filteredObservations = allObservations.filter(item => 
              (item.confirmationCode && item.confirmationCode.toUpperCase().includes(codeUpper)) ||
              (item.id && item.id.toUpperCase().includes(codeUpper))
            );
          } else if (searchTerm) {
            // –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫
            const searchLower = searchTerm.toLowerCase();
            filteredObservations = allObservations.filter(item => 
              (item.name && item.name.toLowerCase().includes(searchLower)) ||
              (item.companyObserver && item.companyObserver.toLowerCase().includes(searchLower)) ||
              (item.companyObserved && item.companyObserved.toLowerCase().includes(searchLower)) ||
              (item.areaText && item.areaText.toLowerCase().includes(searchLower)) ||
              (item.typeObservationText && item.typeObservationText.toLowerCase().includes(searchLower))
            );
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
          filteredObservations.sort((a, b) => {
            const dateA = a.observationDate || a.createdAt || new Date(0);
            const dateB = b.observationDate || b.createdAt || new Date(0);
            return dateB - dateA;
          });
          
          // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
          const totalPages = Math.ceil(filteredObservations.length / itemsPerPage);
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const pageObservations = filteredObservations.slice(startIndex, endIndex);
          
          // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
          tableBody.innerHTML = '';
          
          if (pageObservations.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="9" style="text-align: center; padding: 40px;">
                  <div style="color: #7f8c8d;">${codeSearch || searchTerm ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è'}</div>
                </td>
              </tr>
            `;
          } else {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            pageObservations.forEach(observation => {
              const row = document.createElement('tr');
              
              const date = observation.observationDate ? 
                observation.observationDate.toLocaleDateString('ru-RU') : 
                (observation.createdAt ? observation.createdAt.toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞');
              
              const swaText = observation.swa === '–î–∞' || observation.swa === true ? 
                '<span style="color: #e74c3c; font-weight: bold;">–î–∞</span>' : 
                '–ù–µ—Ç';
              
              const code = observation.confirmationCode || observation.id?.substring(0, 8).toUpperCase() || '‚Äî';
              
              row.innerHTML = `
                <td>${date}</td>
                <td><span class="code-display">${code}</span></td>
                <td>${observation.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${observation.companyObserver || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${observation.companyObserved || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${observation.areaText || observation.area || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${observation.typeObservationText || observation.typeObservation || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${swaText}</td>
                <td>
                  <button class="details-btn" data-id="${observation.id || ''}">
                    –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                  </button>
                </td>
              `;
              
              tableBody.appendChild(row);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.querySelectorAll('.details-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const observationId = this.dataset.id;
                showObservationDetails(observationId);
              });
            });
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
          updatePagination(totalPages);
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞:', error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px; color: #e74c3c;">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}
              </td>
            </tr>
          `;
        }
      }
      
      function updatePagination(totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '‚Üê';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            loadRegisterData(
              document.getElementById('search-input').value,
              document.getElementById('search-code-input').value
            );
          }
        });
        pagination.appendChild(prevBtn);
        
        // –ù—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            loadRegisterData(
              document.getElementById('search-input').value,
              document.getElementById('search-code-input').value
            );
          });
          pagination.appendChild(pageBtn);
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '‚Üí';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            currentPage++;
            loadRegisterData(
              document.getElementById('search-input').value,
              document.getElementById('search-code-input').value
            );
          }
        });
        pagination.appendChild(nextBtn);
      }
      
      function showObservationDetails(observationId) {
        const observation = allObservations.find(obs => obs.id === observationId);
        if (!observation) return;
        
        const modal = document.getElementById('observation-modal');
        const modalContent = document.getElementById('modal-content');
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
        const date = observation.observationDate ? 
          observation.observationDate.toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        const code = observation.confirmationCode || observation.id?.substring(0, 8).toUpperCase() || '–ù–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω';
        
        // –°–æ–∑–¥–∞–µ–º HTML —Å –¥–µ—Ç–∞–ª—è–º–∏
        modalContent.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h3 style="color: #2c3e50; margin-top: 0;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <p><strong>–î–∞—Ç–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</strong> ${date}</p>
              <p><strong>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</strong> <span class="code-display">${code}</span></p>
              <p><strong>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å:</strong> ${observation.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
              <p><strong>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è:</strong> ${observation.companyObserver || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
              <p><strong>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è:</strong> ${observation.companyObserved || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
              <p><strong>–ó–æ–Ω–∞/–õ–æ–∫–∞—Ü–∏—è:</strong> ${observation.areaText || observation.area || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
            </div>
            <div>
              <h3 style="color: #2c3e50; margin-top: 0;">–î–µ—Ç–∞–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h3>
              <p><strong>–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</strong> ${observation.typeObservationText || observation.typeObservation || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
              <p><strong>–†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:</strong> ${observation.swa === '–î–∞' || observation.swa === true ? '–î–∞' : '–ù–µ—Ç'}</p>
              <p><strong>–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:</strong> ${Array.isArray(observation.typeHazard) ? observation.typeHazard.join(', ') : (observation.typeHazard || '–ù–µ —É–∫–∞–∑–∞–Ω—ã')}</p>
              <p><strong>ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> <small>${observation.id || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></p>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #2c3e50;">–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (–ß—Ç–æ —è –≤–∏–∂—É?)</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">
              ${observation.detection || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #2c3e50;">–†–µ–∞–∫—Ü–∏—è (–ß—Ç–æ —è –¥–µ–ª–∞—é?)</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">
              ${observation.reaction || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #2c3e50;">–†–µ—à–µ–Ω–∏–µ (–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?)</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">
              ${observation.solution || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
            </div>
          </div>
          
          ${observation.photoUrl ? `
            <div>
              <h3 style="color: #2c3e50;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h3>
              <img src="${observation.photoUrl}" alt="–§–æ—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è" style="max-width: 100%; border-radius: 5px;">
            </div>
          ` : ''}
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
            <button onclick="printObservationDetails('${observationId}')" style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
              üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –¥–µ—Ç–∞–ª–∏
            </button>
          </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        modal.style.display = 'flex';
      }
      
      // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
      function initEventListeners() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.getElementById('refresh-btn').addEventListener('click', refreshData);
        
        // –§–∏–ª—å—Ç—Ä—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.getElementById('filter-company').addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        document.getElementById('filter-area').addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        document.getElementById('filter-date-from').addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        document.getElementById('filter-date-to').addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        document.getElementById('reset-filters').addEventListener('click', () => {
          document.getElementById('filter-company').value = '';
          document.getElementById('filter-area').value = '';
          document.getElementById('filter-date-from').value = '';
          document.getElementById('filter-date-to').value = '';
          selectedPeriod = 'all';
          document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.period === 'all');
          });
          calculateSummaryStats(allObservations);
          updateAllCharts();
        });
        
        // –ü–µ—Ä–∏–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.querySelectorAll('.period-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            selectedPeriod = btn.dataset.period;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            calculateSummaryStats(filterObservations(allObservations));
            updateAllCharts();
          });
        });
        
        // –ü–æ–∏—Å–∫ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–µ
        document.getElementById('search-btn').addEventListener('click', () => {
          currentPage = 1;
          const searchTerm = document.getElementById('search-input').value;
          loadRegisterData(searchTerm, '');
        });
        
        document.getElementById('search-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            currentPage = 1;
            const searchTerm = document.getElementById('search-input').value;
            loadRegisterData(searchTerm, '');
          }
        });
        
        // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
        document.getElementById('search-code-btn').addEventListener('click', () => {
          currentPage = 1;
          const code = document.getElementById('search-code-input').value;
          loadRegisterData('', code);
        });
        
        document.getElementById('search-code-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            currentPage = 1;
            const code = document.getElementById('search-code-input').value;
            loadRegisterData('', code);
          }
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
        document.getElementById('export-excel-full').addEventListener('click', exportToExcel);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('close-modal').addEventListener('click', () => {
          document.getElementById('observation-modal').style.display = 'none';
        });
        
        // –ö–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('observation-modal').addEventListener('click', (e) => {
          if (e.target.id === 'observation-modal') {
            document.getElementById('observation-modal').style.display = 'none';
          }
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä–º–µ"
        document.getElementById('back-to-form-btn').addEventListener('click', () => {
          window.location.href = 'index.html';
        });
      }
      
      // ========== –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê ==========
      function exportToExcel() {
        if (allObservations.length === 0) {
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º CSV –∫–æ–Ω—Ç–µ–Ω—Ç
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        const headers = [
          "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
          "–î–∞—Ç–∞",
          "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å", 
          "–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è",
          "–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è",
          "–ó–æ–Ω–∞",
          "–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è",
          "–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã",
          "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ",
          "–†–µ–∞–∫—Ü–∏—è",
          "–†–µ—à–µ–Ω–∏–µ",
          "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—Ç—ã",
          "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è",
          "ID –¥–æ–∫—É–º–µ–Ω—Ç–∞"
        ];
        csvContent += headers.join(";") + "\n";
        
        // –î–∞–Ω–Ω—ã–µ
        allObservations.forEach(observation => {
          const row = [
            observation.confirmationCode || observation.id?.substring(0, 8).toUpperCase() || '',
            observation.observationDate ? observation.observationDate.toLocaleDateString('ru-RU') : '',
            observation.name || '',
            observation.companyObserver || '',
            observation.companyObserved || '',
            observation.areaText || observation.area || '',
            observation.typeObservationText || observation.typeObservation || '',
            Array.isArray(observation.typeHazard) ? observation.typeHazard.join(', ') : (observation.typeHazard || ''),
            observation.detection || '',
            observation.reaction || '',
            observation.solution || '',
            observation.swa === '–î–∞' || observation.swa === true ? '–î–∞' : '–ù–µ—Ç',
            observation.createdAt ? observation.createdAt.toLocaleDateString('ru-RU') : '',
            observation.id || ''
          ];
          
          // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
          const escapedRow = row.map(cell => {
            if (typeof cell === 'string' && (cell.includes(';') || cell.includes('"') || cell.includes('\n'))) {
              return '"' + cell.replace(/"/g, '""') + '"';
            }
            return cell;
          });
          
          csvContent += escapedRow.join(";") + "\n";
        });
        
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `isafe_observations_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        
        link.click();
        document.body.removeChild(link);
        
        alert(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${allObservations.length} –∑–∞–ø–∏—Å–µ–π`);
      }
      
      // ========== –ó–ê–ü–£–°–ö ==========
      async function init() {
        console.log('–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        initEventListeners();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        await refreshData();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setDate(today.getDate() - 30);
        document.getElementById('filter-date-from').valueAsDate = monthAgo;
        document.getElementById('filter-date-to').valueAsDate = today;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏ –¥–µ—Ç–∞–ª–µ–π –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
      window.printObservationDetails = function(observationId) {
        const observation = allObservations.find(obs => obs.id === observationId);
        if (!observation) return;
        
        const printContent = `
          <html>
          <head>
            <title>–î–µ—Ç–∞–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è i-SAFE</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3498db; padding-bottom: 15px; }
              .section { margin: 20px 0; }
              .section h3 { color: #2c3e50; background: #f8f9fa; padding: 10px; border-radius: 4px; }
              .field { margin: 10px 0; }
              .field strong { display: inline-block; width: 200px; }
              .code { font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px; background: #f0f0f0; padding: 10px; border-radius: 4px; text-align: center; margin: 15px 0; }
              .content-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; }
              .footer { margin-top: 40px; font-size: 12px; color: #666; text-align: center; border-top: 1px solid #ddd; padding-top: 15px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>i-SAFE - –î–µ—Ç–∞–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h1>
              <p>–ö–∞—Ä—Ç–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º–∏</p>
            </div>
            
            <div class="section">
              <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="field"><strong>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</strong> ${observation.confirmationCode || observation.id?.substring(0, 8).toUpperCase() || '–ù–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω'}</div>
              <div class="field"><strong>–î–∞—Ç–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</strong> ${observation.observationDate ? observation.observationDate.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
              <div class="field"><strong>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å:</strong> ${observation.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
              <div class="field"><strong>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è:</strong> ${observation.companyObserver || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
              <div class="field"><strong>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è:</strong> ${observation.companyObserved || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
              <div class="field"><strong>–ó–æ–Ω–∞/–õ–æ–∫–∞—Ü–∏—è:</strong> ${observation.areaText || observation.area || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
              <div class="field"><strong>–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</strong> ${observation.typeObservationText || observation.typeObservation || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
              <div class="field"><strong>–†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:</strong> ${observation.swa === '–î–∞' || observation.swa === true ? '–î–∞' : '–ù–µ—Ç'}</div>
              <div class="field"><strong>–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:</strong> ${Array.isArray(observation.typeHazard) ? observation.typeHazard.join(', ') : (observation.typeHazard || '–ù–µ —É–∫–∞–∑–∞–Ω—ã')}</div>
            </div>
            
            <div class="section">
              <h3>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (–ß—Ç–æ —è –≤–∏–∂—É?)</h3>
              <div class="content-box">${observation.detection || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            
            <div class="section">
              <h3>–†–µ–∞–∫—Ü–∏—è (–ß—Ç–æ —è –¥–µ–ª–∞—é?)</h3>
              <div class="content-box">${observation.reaction || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            
            <div class="section">
              <h3>–†–µ—à–µ–Ω–∏–µ (–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?)</h3>
              <div class="content-box">${observation.solution || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            
            <div class="footer">
              <p>i-SAFE Observation System ‚Ä¢ ${new Date().getFullYear()}</p>
              <p>–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date().toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</p>
              <p>ID –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${observation.id || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
            </div>
          </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
      };
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
      init();
    });
  </script>
</body>
</html>