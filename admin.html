<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å i-SAFE</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ */
        
        .verdict-system {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .verdict-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .verdict-header h3 {
            color: #333;
            font-size: 16px;
        }
        
        .verdict-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .verdict-info-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .verdict-label {
            font-weight: 600;
            color: #555;
            min-width: 180px;
        }
        
        .verdict-value {
            color: #333;
            flex: 1;
        }
        
        .verdict-form {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .verdict-form-group {
            margin-bottom: 15px;
        }
        
        .verdict-form-group label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .verdict-input, .verdict-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s;
        }
        
        .verdict-input:focus, .verdict-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .verdict-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .verdict-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .verdict-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-save-verdict {
            background: #2ecc71;
            color: white;
        }
        
        .btn-save-verdict:hover {
            background: #27ae60;
        }
        
        .btn-cancel-verdict {
            background: #e74c3c;
            color: white;
        }
        
        .btn-cancel-verdict:hover {
            background: #c0392b;
        }
        
        .verdict-history {
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .verdict-history h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .verdict-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }
        
        .verdict-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
            color: #666;
        }
        
        .verdict-item-content {
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .verdict-item-details {
            font-size: 11px;
            color: #666;
        }
        
        .verdict-reinduction {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .verdict-warning {
            background: #fffde7;
            border-left-color: #ffeb3b;
        }
        
        .verdict-critical {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .verdict-template {
            margin-top: 15px;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            border: 1px dashed #3498db;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .verdict-template:hover {
            background: #e3f2fd;
        }
        
        .verdict-template h5 {
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .verdict-template-text {
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å... -->
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
        const VERDICT_TEMPLATES = [
            {
                id: 'reinduction',
                name: '–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ',
                text: '–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —á—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ–º–∞–º: ${hazards}. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.',
                type: 'reinduction',
                color: '#4caf50'
            },
            {
                id: 'safety_violation',
                name: '–ù–∞—Ä—É—à–µ–Ω–∏–µ –¢–ë',
                text: '–í—ã—è–≤–ª–µ–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ —Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏ –∏ —É—Å–∏–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª –¢–ë –Ω–∞ —É—á–∞—Å—Ç–∫–µ ${location}.',
                type: 'warning',
                color: '#ffeb3b'
            },
            {
                id: 'equipment_issue',
                name: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º',
                text: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞. –î–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.',
                type: 'critical',
                color: '#f44336'
            },
            {
                id: 'housekeeping',
                name: '–ü–æ—Ä—è–¥–æ–∫ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ',
                text: '–ù–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ ${location} –≤—ã—è–≤–ª–µ–Ω–æ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —É–±–æ—Ä–∫—É –∏ –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ 5S.',
                type: 'warning',
                color: '#ff9800'
            },
            {
                id: 'positive_observation',
                name: '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä',
                text: '–û—Ç–º–µ—á–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –î–∞–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏—Ç—å —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ ${observationCompany}.',
                type: 'positive',
                color: '#4caf50'
            }
        ];

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é viewObservation –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
        async function viewObservation(observationId) {
            try {
                const doc = await db.collection('observations').doc(observationId).get();
                const observation = doc.data();
                
                if (!observation) {
                    showError('error-message', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                const commentsHtml = observation.comments && observation.comments.length > 0 
                    ? observation.comments.map(comment => `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span>${comment.author || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</span>
                                <span>${formatDate(comment.timestamp)}</span>
                            </div>
                            <div class="comment-text">${comment.text}</div>
                        </div>
                    `).join('')
                    : '<p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                
                // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–µ—Ä–¥–∏–∫—Ç—ã
                const verdictsSnapshot = await db.collection('verdicts')
                    .where('observationId', '==', observationId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const verdicts = [];
                verdictsSnapshot.forEach(doc => {
                    const verdict = doc.data();
                    verdict.id = doc.id;
                    verdicts.push(verdict);
                });
                
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
                const verdictSystemHtml = createVerdictSystemHtml(observation, verdicts);
                
                const detailsHtml = `
                    <div class="detail-group">
                        <label>–ù–æ–º–µ—Ä –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                        <div class="detail-value">${observation.observationNumber}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</label>
                        <div class="detail-value">${formatDate(observation.createdAt)}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è:</label>
                        <div class="detail-value">${observation.observer_company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                        <div class="detail-value">${observation.observation_company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å:</label>
                        <div class="detail-value">${observation.observer_name}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–ú–µ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                        <div class="detail-value">${observation.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                        <div class="detail-value">${observation.observation_type_text || observation.observation_type}</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:</label>
                        <div class="detail-value">
                            <div class="hazards-list">
                                ${observation.hazards && observation.hazards.length > 0 
                                    ? observation.hazards.map(h => `<span class="hazard-tag">${h}</span>`).join('')
                                    : '<span>–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <label>–°—Ç–∞—Ç—É—Å:</label>
                        <div class="detail-value">
                            <span class="status-badge ${getStatusClass(observation.status)}">
                                ${observation.status || '–ù–æ–≤–æ–µ'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="color-box red-bg">
                        <strong>–û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï (–ß—Ç–æ —è –≤–∏–∂—É?):</strong>
                        <p style="margin-top: 10px;">${observation.observation_description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    </div>
                    
                    <div class="color-box yellow-bg">
                        <strong>–†–ï–ê–ö–¶–ò–Ø (–ß—Ç–æ —è –¥–µ–ª–∞—é?):</strong>
                        <p style="margin-top: 10px;">${observation.reaction_description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    </div>
                    
                    <div class="color-box green-bg">
                        <strong>–†–ï–®–ï–ù–ò–ï (–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?):</strong>
                        <p style="margin-top: 10px;">${observation.solution_description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    </div>
                    
                    ${verdictSystemHtml}
                    
                    <div class="comment-section">
                        <label><strong>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong></label>
                        <textarea id="adminComment" class="comment-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                        <button onclick="addComment('${observationId}')" class="action-btn btn-view" style="width: 100%; margin-bottom: 10px;">
                            ‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                        
                        <div class="comments-list" id="commentsList">
                            <h4 style="margin-top: 20px; margin-bottom: 10px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h4>
                            ${commentsHtml}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="changeStatus('${observationId}', '–í —Ä–∞–±–æ—Ç–µ')" class="action-btn btn-inprogress" style="margin-right: 10px;">
                            ‚öôÔ∏è –í —Ä–∞–±–æ—Ç—É
                        </button>
                        <button onclick="changeStatus('${observationId}', '–ó–∞–∫—Ä—ã—Ç–æ')" class="action-btn btn-close">
                            ‚úÖ –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
                
                document.getElementById('observationDetails').innerHTML = detailsHtml;
                document.getElementById('detailModal').style.display = 'flex';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
                initializeVerdictHandlers(observationId, observation);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:', error);
                showError('error-message', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏—è');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
        function createVerdictSystemHtml(observation, verdicts) {
            const observationCompany = observation.observation_company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            const location = observation.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const hazards = observation.hazards ? observation.hazards.join(', ') : '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
            
            // HTML –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–∏
            const infoHtml = `
                <div class="verdict-info">
                    <div class="verdict-info-item">
                        <span class="verdict-label">–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</span>
                        <span class="verdict-value">${observationCompany}</span>
                    </div>
                    <div class="verdict-info-item">
                        <span class="verdict-label">–ú–µ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</span>
                        <span class="verdict-value">${location}</span>
                    </div>
                    <div class="verdict-info-item">
                        <span class="verdict-label">–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:</span>
                        <span class="verdict-value">${hazards}</span>
                    </div>
                </div>
            `;
            
            // HTML –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
            let verdictHistoryHtml = '<p>–í–µ—Ä–¥–∏–∫—Ç—ã –µ—â–µ –Ω–µ –≤—ã–Ω–æ—Å–∏–ª–∏—Å—å</p>';
            if (verdicts.length > 0) {
                verdictHistoryHtml = verdicts.map(verdict => {
                    const verdictClass = verdict.type || 'default';
                    return `
                        <div class="verdict-item verdict-${verdictClass}">
                            <div class="verdict-item-header">
                                <span>${verdict.author || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</span>
                                <span>${formatDate(verdict.createdAt)}</span>
                            </div>
                            <div class="verdict-item-content">${verdict.text}</div>
                            <div class="verdict-item-details">
                                –¢–∏–ø: ${verdict.verdictType || '–û–±—â–∏–π'} | 
                                –ö–æ–º–ø–∞–Ω–∏—è: ${verdict.observationCompany || observationCompany} | 
                                –ú–µ—Å—Ç–æ: ${verdict.location || location}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // HTML –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
            const templatesHtml = VERDICT_TEMPLATES.map(template => `
                <div class="verdict-template" onclick="selectVerdictTemplate('${template.id}', '${observationCompany}', '${location}', '${hazards}')">
                    <h5>${template.name}</h5>
                    <div class="verdict-template-text">${template.text}</div>
                </div>
            `).join('');
            
            return `
                <div class="verdict-system">
                    <div class="verdict-header">
                        <h3>‚öñÔ∏è –°–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–¥–∏–∫—Ç–æ–≤</h3>
                    </div>
                    
                    ${infoHtml}
                    
                    <div class="verdict-form">
                        <div class="verdict-form-group">
                            <label>–¢–∏–ø –≤–µ—Ä–¥–∏–∫—Ç–∞:</label>
                            <select id="verdictType" class="verdict-input">
                                <option value="general">–û–±—â–∏–π</option>
                                <option value="reinduction">–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ</option>
                                <option value="warning">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                                <option value="critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                                <option value="positive">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π</option>
                            </select>
                        </div>
                        
                        <div class="verdict-form-group">
                            <label>–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                            <input type="text" id="verdictCompany" class="verdict-input" value="${observationCompany}">
                        </div>
                        
                        <div class="verdict-form-group">
                            <label>–ú–µ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label>
                            <input type="text" id="verdictLocation" class="verdict-input" value="${location}">
                        </div>
                        
                        <div class="verdict-form-group">
                            <label>–¢–µ–∫—Å—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞:</label>
                            <textarea id="verdictText" class="verdict-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞..."></textarea>
                        </div>
                        
                        <div class="verdict-form-group">
                            <label>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã:</label>
                            <div id="verdictTemplates">
                                ${templatesHtml}
                            </div>
                        </div>
                        
                        <div class="verdict-buttons">
                            <button onclick="saveVerdict()" class="verdict-btn btn-save-verdict">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Ä–¥–∏–∫—Ç</button>
                            <button onclick="clearVerdictForm()" class="verdict-btn btn-cancel-verdict">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="verdict-history">
                        <h4>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä–¥–∏–∫—Ç–æ–≤:</h4>
                        <div id="verdictHistory">
                            ${verdictHistoryHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–µ—Ä–¥–∏–∫—Ç–æ–≤
        function initializeVerdictHandlers(observationId, observation) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            window.currentObservationId = observationId;
            window.currentObservation = observation;
        }

        // –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –≤–µ—Ä–¥–∏–∫—Ç–∞
        function selectVerdictTemplate(templateId, company, location, hazards) {
            const template = VERDICT_TEMPLATES.find(t => t.id === templateId);
            if (!template) return;
            
            // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ —à–∞–±–ª–æ–Ω–∞
            let text = template.text;
            text = text.replace(/\${observationCompany}/g, company);
            text = text.replace(/\${location}/g, location);
            text = text.replace(/\${hazards}/g, hazards);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('verdictType').value = template.type || 'general';
            document.getElementById('verdictCompany').value = company;
            document.getElementById('verdictLocation').value = location;
            document.getElementById('verdictText').value = text;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            document.getElementById('verdictText').scrollIntoView({ behavior: 'smooth' });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä–¥–∏–∫—Ç–∞
        async function saveVerdict() {
            const observationId = window.currentObservationId;
            const observation = window.currentObservation;
            
            if (!observationId || !observation) {
                alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }
            
            const verdictType = document.getElementById('verdictType').value;
            const verdictCompany = document.getElementById('verdictCompany').value;
            const verdictLocation = document.getElementById('verdictLocation').value;
            const verdictText = document.getElementById('verdictText').value;
            
            if (!verdictText.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞
                const verdictData = {
                    observationId: observationId,
                    observationNumber: observation.observationNumber,
                    verdictType: verdictType,
                    observationCompany: verdictCompany,
                    location: verdictLocation,
                    text: verdictText,
                    author: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
                await db.collection('verdicts').add(verdictData);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ä–¥–∏–∫—Ç–∞
                const currentComments = observation.comments || [];
                const newComment = {
                    text: `–í—ã–Ω–µ—Å–µ–Ω –≤–µ—Ä–¥–∏–∫—Ç —Ç–∏–ø–∞ "${verdictType}": ${verdictText.substring(0, 100)}...`,
                    author: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('observations').doc(observationId).update({
                    comments: [...currentComments, newComment],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                showSuccess('–í–µ—Ä–¥–∏–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                
                // –ï—Å–ª–∏ –≤–µ—Ä–¥–∏–∫—Ç —Ç–∏–ø–∞ "reinduction", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ
                if (verdictType === 'reinduction') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—à–µ–Ω–∏–µ –≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–∏
                    await db.collection('observations').doc(observationId).update({
                        solution_description: verdictText,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ
                    showTrainingRequestButton(observationId, observation.hazards || []);
                }
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                clearVerdictForm();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
                viewObservation(observationId);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä–¥–∏–∫—Ç–∞:', error);
                showError('error-message', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä–¥–∏–∫—Ç–∞: ' + error.message);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ
        function showTrainingRequestButton(observationId, hazards) {
            const commentSection = document.querySelector('.comment-section');
            if (commentSection) {
                const existingButton = commentSection.querySelector('.training-request-button');
                if (!existingButton) {
                    const buttonHtml = `
                        <button onclick="openTrainingRequest('${observationId}', ${JSON.stringify(hazards)})" 
                                class="action-btn training-request-button" 
                                style="width: 100%; background: #9b59b6; color: white; margin-top: 10px;">
                            üìö –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ
                        </button>
                    `;
                    
                    const textarea = commentSection.querySelector('textarea');
                    if (textarea) {
                        textarea.insertAdjacentHTML('afterend', buttonHtml);
                    }
                }
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤–µ—Ä–¥–∏–∫—Ç–∞
        function clearVerdictForm() {
            document.getElementById('verdictType').value = 'general';
            document.getElementById('verdictText').value = '';
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –º–µ—Å—Ç–∞
            if (window.currentObservation) {
                document.getElementById('verdictCompany').value = window.currentObservation.observation_company || '';
                document.getElementById('verdictLocation').value = window.currentObservation.location || '';
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –º–µ—Å—Ç–µ
        async function sendNotification(observationId, notificationType) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
                const observationDoc = await db.collection('observations').doc(observationId).get();
                const observation = observationDoc.data();
                
                if (!observation) {
                    alert('–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                const rule = NOTIFICATION_RULES[notificationType];
                if (!rule) {
                    alert('–ü—Ä–∞–≤–∏–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –º–µ—Å—Ç–µ
                const message = `
                    –ù–æ–≤–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ #${observation.observationNumber}
                    –¢–∏–ø: ${rule.name}
                    –ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è: ${observation.observation_company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                    –ú–µ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è: ${observation.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                    –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å: ${observation.observer_name}
                    –î–∞—Ç–∞: ${formatDate(observation.createdAt)}
                `;
                
                // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º...
                // ...
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
                showError('error-message', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + error.message);
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é exportToCSV –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        function exportToCSV() {
            const exportFilter = document.getElementById('exportFilter').value;
            let dataToExport = [];
            
            switch (exportFilter) {
                case 'filtered':
                    dataToExport = filteredObservations;
                    break;
                case 'new':
                    dataToExport = observations.filter(o => o.status === '–ù–æ–≤–æ–µ');
                    break;
                case 'inprogress':
                    dataToExport = observations.filter(o => o.status === '–í —Ä–∞–±–æ—Ç–µ');
                    break;
                case 'closed':
                    dataToExport = observations.filter(o => o.status === '–ó–∞–∫—Ä—ã—Ç–æ');
                    break;
                default:
                    dataToExport = observations;
            }
            
            if (dataToExport.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ CSV —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
            const headers = [
                '–ù–æ–º–µ—Ä', '–î–∞—Ç–∞', '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è', '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è', 
                '–ú–µ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è', '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å', '–¢–∏–ø', '–°—Ç–∞—Ç—É—Å', 
                '–û–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã', '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ', '–†–µ–∞–∫—Ü–∏—è', '–†–µ—à–µ–Ω–∏–µ', 
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏', '–í–µ—Ä–¥–∏–∫—Ç—ã'
            ];
            
            // –î–∞–Ω–Ω—ã–µ
            const rows = dataToExport.map(obs => [
                `"${obs.observationNumber}"`,
                `"${formatDate(obs.observation_date || obs.timestamp)}"`,
                `"${obs.observer_company || ''}"`,
                `"${obs.observation_company || ''}"`,
                `"${obs.location || ''}"`,
                `"${obs.observer_name}"`,
                `"${obs.observation_type_text || obs.observation_type}"`,
                `"${obs.status || '–ù–æ–≤–æ–µ'}"`,
                `"${obs.hazards ? obs.hazards.join(', ') : ''}"`,
                `"${(obs.observation_description || '').replace(/"/g, '""')}"`,
                `"${(obs.reaction_description || '').replace(/"/g, '""')}"`,
                `"${(obs.solution_description || '').replace(/"/g, '""')}"`,
                `"${obs.comments ? obs.comments.map(c => c.text).join('; ') : ''}"`,
                `"${obs.verdicts ? obs.verdicts.map(v => v.text).join('; ') : ''}"`
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `isafe_observations_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportModal();
        }
    </script>
</body>
</html>