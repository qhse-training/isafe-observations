<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º–∏</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body {
      background-color: #f5f7fa;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding-bottom: 30px;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0;
    }
    .controls {
      padding: 15px 20px;
      background: #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .controls button:hover {
      background-color: #2980b9;
    }
    .status-info {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-online {
      background-color: #2ecc71;
    }
    .status-offline {
      background-color: #e74c3c;
    }
    .status-loading {
      background-color: #f39c12;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .filter-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-controls select,
    .filter-controls input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .charts-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 20px;
    }
    .chart-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .chart-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #2c3e50;
      text-align: center;
      font-weight: 600;
    }
    .chart-wrapper {
      position: relative;
      height: 300px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #2c3e50;
      margin: 10px 0;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 0.9rem;
    }
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #3498db;
      font-style: italic;
    }
    .error-message {
      text-align: center;
      padding: 40px;
      color: #e74c3c;
      font-style: italic;
    }
    .period-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .period-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .period-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º–∏</h1>
    </header>

    <div class="controls">
      <div style="display: flex; gap: 10px; align-items: center;">
        <button id="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <div class="status-info">
          <span class="status-dot status-online" id="status-dot"></span>
          <span id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
        </div>
      </div>
      
      <div class="filter-controls">
        <div class="period-selector">
          <button class="period-btn active" data-period="all">–í—Å–µ –≤—Ä–µ–º—è</button>
          <button class="period-btn" data-period="month">–ó–∞ –º–µ—Å—è—Ü</button>
          <button class="period-btn" data-period="week">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
          <button class="period-btn" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
        <select id="filter-company">
          <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
        </select>
        <select id="filter-area">
          <option value="">–í—Å–µ –∑–æ–Ω—ã</option>
        </select>
        <input type="date" id="filter-date-from" placeholder="–° –¥–∞—Ç—ã">
        <input type="date" id="filter-date-to" placeholder="–ü–æ –¥–∞—Ç—É">
        <button id="reset-filters" style="background-color: #95a5a6;">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      
      <div>
        <button id="back-to-form-btn" style="background-color: #27ae60;">‚Üê –ö —Ñ–æ—Ä–º–µ</button>
        <button id="view-register-btn" style="background-color: #9b59b6;">üìã –ö —Ä–µ–≥–∏—Å—Ç—Ä—É</button>
      </div>
    </div>

    <!-- –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="summary-stats" id="summary-stats">
      <div class="stat-card">
        <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</div>
        <div class="stat-value" id="total-observations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</div>
        <div class="stat-value" id="unsafe-conditions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
        <div class="stat-value" id="unsafe-actions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
        <div class="stat-value" id="work-stopped">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏</div>
        <div class="stat-value" id="unique-observers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
        <div class="stat-value" id="avg-per-day">0</div>
      </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-container" id="charts-container">
      <div class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</div>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCpI00DhnV2AqrVxE7eJ5nLyo7icFobLoU",
      authDomain: "i-safe-8aff1.firebaseapp.com",
      projectId: "i-safe-8aff1",
      storageBucket: "i-safe-8aff1.firebasestorage.app",
      messagingSenderId: "721183035804",
      appId: "1:721183035804:web:f81eba42fe1f272c1f3859",
      measurementId: "G-5737V4DSJJ"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", async function () {
      // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const refreshBtn = document.getElementById('refresh-btn');
      const backToFormBtn = document.getElementById('back-to-form-btn');
      const viewRegisterBtn = document.getElementById('view-register-btn');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const filterCompany = document.getElementById('filter-company');
      const filterArea = document.getElementById('filter-area');
      const filterDateFrom = document.getElementById('filter-date-from');
      const filterDateTo = document.getElementById('filter-date-to');
      const resetFiltersBtn = document.getElementById('reset-filters');
      const periodButtons = document.querySelectorAll('.period-btn');
      const summaryStats = document.getElementById('summary-stats');
      const chartsContainer = document.getElementById('charts-container');
      
      let allObservations = [];
      let currentCharts = [];
      let selectedPeriod = 'all';
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      function updateConnectionStatus(isLoading = false) {
        const isOnline = navigator.onLine;
        
        if (isLoading) {
          statusDot.className = 'status-dot status-loading';
          statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
        } else if (isOnline) {
          statusDot.className = 'status-dot status-online';
          statusText.textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase';
        } else {
          statusDot.className = 'status-dot status-offline';
          statusText.textContent = '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º (–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)';
        }
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
      async function loadObservationsFromFirebase() {
        try {
          updateConnectionStatus(true);
          
          const querySnapshot = await db.collection('observations')
            .orderBy('createdAt', 'desc')
            .get();
          
          const observations = [];
          const companies = new Set();
          const areas = new Set();
          
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            observations.push({
              id: doc.id,
              ...data,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
              observationDate: data.observationDateTime ? new Date(data.observationDateTime) : (data.createdAt ? data.createdAt.toDate() : new Date())
            });
            
            if (data.companyObserver) companies.add(data.companyObserver);
            if (data.companyObserved) companies.add(data.companyObserved);
            if (data.areaText) areas.add(data.areaText);
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
          updateFilterOptions(companies, areas);
          
          updateConnectionStatus(false);
          return observations;
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
          
          // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
          return loadObservationsFromLocalStorage();
        }
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
      function loadObservationsFromLocalStorage() {
        const localData = JSON.parse(localStorage.getItem('hseObservations') || '[]');
        const companies = new Set();
        const areas = new Set();
        
        const observations = localData.map(item => {
          if (item.companyObserver) companies.add(item.companyObserver);
          if (item.companyObserved) companies.add(item.companyObserved);
          if (item.areaText) areas.add(item.areaText);
          
          return {
            ...item,
            observationDate: item.observationDateTime ? new Date(item.observationDateTime) : 
                            (item.savedAt ? new Date(item.savedAt) : new Date())
          };
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        updateFilterOptions(companies, areas);
        
        updateConnectionStatus(false);
        return observations;
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function updateFilterOptions(companies, areas) {
        // –ö–æ–º–ø–∞–Ω–∏–∏
        filterCompany.innerHTML = '<option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>';
        companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company;
          option.textContent = company;
          filterCompany.appendChild(option);
        });
        
        // –ó–æ–Ω—ã
        filterArea.innerHTML = '<option value="">–í—Å–µ –∑–æ–Ω—ã</option>';
        areas.forEach(area => {
          const option = document.createElement('option');
          option.value = area;
          option.textContent = area;
          filterArea.appendChild(option);
        });
      }
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–µ—Ä–∏–æ–¥–∞
      function filterObservations(observations) {
        const companyFilter = filterCompany.value;
        const areaFilter = filterArea.value;
        const dateFrom = filterDateFrom.value ? new Date(filterDateFrom.value) : null;
        const dateTo = filterDateTo.value ? new Date(filterDateTo.value) : null;
        
        let filtered = observations.filter(item => {
          // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
          if (companyFilter && 
              item.companyObserver !== companyFilter && 
              item.companyObserved !== companyFilter) {
            return false;
          }
          
          // –§–∏–ª—å—Ç—Ä –ø–æ –∑–æ–Ω–µ
          if (areaFilter && item.areaText !== areaFilter && item.area !== areaFilter) {
            return false;
          }
          
          // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
          const itemDate = item.observationDate;
          
          if (dateFrom && itemDate < dateFrom) {
            return false;
          }
          
          if (dateTo) {
            const dateToPlusOne = new Date(dateTo);
            dateToPlusOne.setDate(dateToPlusOne.getDate() + 1);
            
            if (itemDate >= dateToPlusOne) {
              return false;
            }
          }
          
          return true;
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–∏–æ–¥
        filtered = applyPeriodFilter(filtered, selectedPeriod);
        
        return filtered;
      }
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É
      function applyPeriodFilter(observations, period) {
        if (period === 'all') return observations;
        
        const now = new Date();
        let startDate = new Date();
        
        switch (period) {
          case 'today':
            startDate.setHours(0, 0, 0, 0);
            break;
          case 'week':
            startDate.setDate(now.getDate() - 7);
            break;
          case 'month':
            startDate.setMonth(now.getMonth() - 1);
            break;
        }
        
        return observations.filter(item => {
          return item.observationDate >= startDate;
        });
      }
      
      // –†–∞—Å—á–µ—Ç —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      function calculateSummaryStats(observations) {
        const total = observations.length;
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
        const unsafeConditions = observations.filter(item => 
          item.typeObservation === 'unsafe-condition' || 
          item.typeObservationText === '–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ'
        ).length;
        
        const unsafeActions = observations.filter(item => 
          item.typeObservation === 'unsafe-action' || 
          item.typeObservationText === '–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ'
        ).length;
        
        // –†–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
        const workStopped = observations.filter(item => 
          item.swa === '–î–∞' || item.swa === true
        ).length;
        
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
        const uniqueObservers = new Set(observations.map(item => item.name)).size;
        
        // –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å
        const dates = observations.map(item => {
          const date = item.observationDate;
          return date.toISOString().split('T')[0];
        });
        const uniqueDates = new Set(dates).size;
        const avgPerDay = uniqueDates > 0 ? (total / uniqueDates).toFixed(1) : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-observations').textContent = total;
        document.getElementById('unsafe-conditions').textContent = unsafeConditions;
        document.getElementById('unsafe-actions').textContent = unsafeActions;
        document.getElementById('work-stopped').textContent = workStopped;
        document.getElementById('unique-observers').textContent = uniqueObservers;
        document.getElementById('avg-per-day').textContent = avgPerDay;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
      function createChart(ctxId, labelExtractor, title, type = "bar") {
        const ctx = document.getElementById(ctxId);
        if (!ctx) return null;
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
        const filteredObservations = filterObservations(allObservations);
        
        // –°—á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const counts = {};
        filteredObservations.forEach(item => {
          const label = labelExtractor(item);
          if (label) {
            if (Array.isArray(label)) {
              label.forEach(l => {
                counts[l] = (counts[l] || 0) + 1;
              });
            } else {
              counts[label] = (counts[label] || 0) + 1;
            }
          }
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (—É–±—ã–≤–∞–Ω–∏—é)
        const sortedLabels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
        const sortedCounts = sortedLabels.map(label => counts[label]);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const maxItems = 15;
        const displayLabels = sortedLabels.slice(0, maxItems);
        const displayCounts = sortedCounts.slice(0, maxItems);
        
        if (displayLabels.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type,
          data: {
            labels: displayLabels,
            datasets: [{
              label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
              data: displayCounts,
              backgroundColor: displayLabels.map((_, i) => {
                const hue = (i * 40) % 360;
                return `hsl(${hue}, 70%, 50%)`;
              }),
              borderColor: displayLabels.map((_, i) => {
                const hue = (i * 40) % 360;
                return `hsl(${hue}, 70%, 30%)`;
              }),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: title,
                font: { size: 16 }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const total = filteredObservations.length;
                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                    return `${context.label}: ${context.raw} (${percentage}%)`;
                  }
                }
              }
            },
            scales: type === 'bar' ? {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            } : {}
          }
        });
        
        return chart;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
      function createHazardFactorsChart() {
        const ctx = document.getElementById("hazardFactorsChart");
        if (!ctx) return null;
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const filteredObservations = filterObservations(allObservations);
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const groups = {
          "–§–∏–∑–∏—á–µ—Å–∫–∏–µ": [
            "–®—É–º","–í–∏–±—Ä–∞—Ü–∏—è","–†–∞–¥–∏–∞—Ü–∏—è","–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞","–†–∞–±–æ—Ç–∞ –Ω–∞ –≤—ã—Å–æ—Ç–µ",
            "–¢—è–∂—ë–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞","–†—É—á–Ω—ã–µ –∏ –ø–µ—Ä–µ–Ω–æ—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã","–ü–∞–¥–∞—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
            "–õ–µ—Ç—è—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã","–ü–æ–¥—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ, –°–ø–æ—Ç—ã–∫–∞–Ω–∏–µ","–ö—Ä—É—Ç—è—â–∏–µ—Å—è –∏ –≤—Ä–∞—â–∞—é—â–∏–µ—Å—è",
            "–≠–ª–µ–∫—Ç—Ä–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç","–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
          ],
          "–•–∏–º–∏—á–µ—Å–∫–∏–µ –∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": ["–•–∏–º–∏—á–µ—Å–∫–∞—è","–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è"],
          "–ü—Å–∏—Ö–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": ["–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä","–≠—Ä–≥–æ–Ω–æ–º–∏–∫–∞","–ü—Å–∏—Ö–æ—Ç—Ä–æ–ø–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞","–†—É—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ"],
          "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ": ["–°–ò–ó","–£–±–æ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞","–ó–∞–º–∫–Ω—É—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ","–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞","–ü–æ–∂–∞—Ä–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","–û—Å–≤–µ—â–µ–Ω–∏–µ"]
        };
        
        // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –≥—Ä—É–ø–ø–∞–º
        const groupCounts = {};
        Object.keys(groups).forEach(group => {
          groupCounts[group] = 0;
        });
        
        // –°—á–∏—Ç–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const factorCounts = {};
        Object.values(groups).flat().forEach(factor => factorCounts[factor] = 0);
        
        filteredObservations.forEach(item => {
          let hazardList = [];
          if (Array.isArray(item.typeHazard)) {
            hazardList = item.typeHazard;
          } else if (typeof item.typeHazard === "string" && item.typeHazard) {
            hazardList = item.typeHazard.split(",").map(h => h.trim());
          }
          
          hazardList.forEach(h => {
            if (factorCounts[h] !== undefined) {
              factorCounts[h]++;
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä—É–ø–ø—É
              for (const [group, factors] of Object.entries(groups)) {
                if (factors.includes(h)) {
                  groupCounts[group]++;
                  break;
                }
              }
            }
          });
        });
        
        // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const datasets = [];
        let colorIndex = 0;
        
        Object.entries(groups).forEach(([group, factors]) => {
          factors.forEach(factor => {
            if (factorCounts[factor] > 0) {
              datasets.push({
                label: factor,
                data: [
                  group === "–§–∏–∑–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–•–∏–º–∏—á–µ—Å–∫–∏–µ –∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–ü—Å–∏—Ö–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0,
                  group === "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ" ? factorCounts[factor] : 0
                ],
                backgroundColor: `hsl(${colorIndex * 30 % 360}, 70%, 50%)`
              });
              colorIndex++;
            }
          });
        });
        
        if (datasets.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type: "bar",
          data: {
            labels: Object.keys(groups),
            datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  boxWidth: 15,
                  font: { size: 11 }
                }
              },
              title: {
                display: true,
                text: "–û–ø–∞—Å–Ω—ã–µ –∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã",
                font: { size: 16 }
              }
            },
            scales: {
              x: {
                stacked: true,
                title: {
                  display: true,
                  text: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–æ–≤'
                }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π'
                }
              }
            }
          }
        });
        
        return chart;
      }
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –¥–Ω—è–º
      function createDailyChart() {
        const ctx = document.getElementById("dailyChart");
        if (!ctx) return null;
        
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const filteredObservations = filterObservations(allObservations);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
        const dailyCounts = {};
        filteredObservations.forEach(item => {
          const date = item.observationDate.toISOString().split('T')[0];
          const formattedDate = new Date(date).toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit'
          });
          dailyCounts[formattedDate] = (dailyCounts[formattedDate] || 0) + 1;
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        const sortedDates = Object.keys(dailyCounts).sort((a, b) => {
          return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
        });
        const sortedCounts = sortedDates.map(date => dailyCounts[date]);
        
        if (sortedDates.length === 0) {
          ctx.parentElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #7f8c8d;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º</div>`;
          return null;
        }
        
        const chart = new Chart(ctx.getContext("2d"), {
          type: "line",
          data: {
            labels: sortedDates,
            datasets: [{
              label: "–ù–∞–±–ª—é–¥–µ–Ω–∏–π –≤ –¥–µ–Ω—å",
              data: sortedCounts,
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "–î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –¥–Ω—è–º",
                font: { size: 16 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                }
              },
              x: {
                title: {
                  display: true,
                  text: '–î–∞—Ç–∞'
                }
              }
            }
          }
        });
        
        return chart;
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
      function updateAllCharts() {
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        chartsContainer.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartTemplates = [
          { id: 'observerCompanyChart', title: '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è', extractor: item => item.companyObserver },
          { id: 'observedCompanyChart', title: '–ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–∞–µ–º–∞—è', extractor: item => item.companyObserved },
          { id: 'locationChart', title: '–ú–µ—Å—Ç–æ (–ª–æ–∫–∞—Ü–∏—è)', extractor: item => item.areaText || item.area },
          { id: 'observationTypeChart', title: '–¢–∏–ø –Ω–∞–±–ª—é–¥–µ–Ω–∏—è', extractor: item => item.typeObservationText || item.typeObservation },
          { id: 'stopWorkChart', title: '–û—Å—Ç–∞–Ω–æ–≤–∏–ª —Ä–∞–±–æ—Ç—É', extractor: item => item.swa },
          { id: 'reactionChart', title: '–†–µ–∞–∫—Ü–∏—è (–ß—Ç–æ —è –¥–µ–ª–∞—é?)', extractor: item => item.reaction ? item.reaction.substring(0, 50) + (item.reaction.length > 50 ? '...' : '') : null },
          { id: 'findingChart', title: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (–ß—Ç–æ —è –≤–∏–∂—É?)', extractor: item => item.detection ? item.detection.substring(0, 50) + (item.detection.length > 50 ? '...' : '') : null },
          { id: 'solutionChart', title: '–†–µ—à–µ–Ω–∏–µ (–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?)', extractor: item => item.solution ? item.solution.substring(0, 50) + (item.solution.length > 50 ? '...' : '') : null },
          { id: 'dailyChart', title: '–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º', type: 'line' }
        ];
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        chartTemplates.forEach((template, index) => {
          const chartCard = document.createElement('div');
          chartCard.className = 'chart-card';
          if (template.id === 'dailyChart') {
            chartCard.classList.add('full-width');
          }
          
          chartCard.innerHTML = `
            <div class="chart-title">${template.title}</div>
            <div class="chart-wrapper"><canvas id="${template.id}"></canvas></div>
          `;
          
          chartsContainer.appendChild(chartCard);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const hazardCard = document.createElement('div');
        hazardCard.className = 'chart-card full-width';
        hazardCard.innerHTML = `
          <div class="chart-title">–û–ø–∞—Å–Ω—ã–µ –∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</div>
          <div class="chart-wrapper"><canvas id="hazardFactorsChart"></canvas></div>
        `;
        chartsContainer.appendChild(hazardCard);
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        currentCharts = [];
        
        chartTemplates.forEach(template => {
          let chart;
          if (template.id === 'dailyChart') {
            chart = createDailyChart();
          } else if (template.id === 'hazardFactorsChart') {
            chart = createHazardFactorsChart();
          } else {
            chart = createChart(template.id, template.extractor, template.title, template.type);
          }
          if (chart) currentCharts.push(chart);
        });
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–ø–∞—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        const hazardChart = createHazardFactorsChart();
        if (hazardChart) currentCharts.push(hazardChart);
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
      async function refreshData() {
        try {
          updateConnectionStatus(true);
          
          if (navigator.onLine) {
            allObservations = await loadObservationsFromFirebase();
          } else {
            allObservations = loadObservationsFromLocalStorage();
          }
          
          calculateSummaryStats(allObservations);
          updateAllCharts();
          
          statusText.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allObservations.length} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π`;
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
          chartsContainer.innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
          statusText.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        } finally {
          updateConnectionStatus(false);
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π
      function initEventListeners() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        refreshBtn.addEventListener('click', refreshData);
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        backToFormBtn.addEventListener('click', () => {
          window.location.href = '–ö–∞—Ä—Ç–∞.html';
        });
        
        viewRegisterBtn.addEventListener('click', () => {
          window.open('–†–µ–≥–∏—Å—Ç—Ä.html', '_blank');
        });
        
        // –§–∏–ª—å—Ç—Ä—ã
        filterCompany.addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        filterArea.addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        filterDateFrom.addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        filterDateTo.addEventListener('change', () => {
          calculateSummaryStats(filterObservations(allObservations));
          updateAllCharts();
        });
        
        resetFiltersBtn.addEventListener('click', () => {
          filterCompany.value = '';
          filterArea.value = '';
          filterDateFrom.value = '';
          filterDateTo.value = '';
          selectedPeriod = 'all';
          periodButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.period === 'all');
          });
          calculateSummaryStats(allObservations);
          updateAllCharts();
        });
        
        // –ü–µ—Ä–∏–æ–¥—ã
        periodButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            selectedPeriod = btn.dataset.period;
            periodButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            calculateSummaryStats(filterObservations(allObservations));
            updateAllCharts();
          });
        });
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–µ—Ç–∏
        window.addEventListener('online', refreshData);
        window.addEventListener('offline', () => {
          statusDot.className = 'status-dot status-offline';
          statusText.textContent = '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
        });
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      async function init() {
        console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        initEventListeners();
        await refreshData();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setDate(today.getDate() - 30);
        
        filterDateFrom.valueAsDate = monthAgo;
        filterDateTo.valueAsDate = today;
      }
      
      // –ó–∞–ø—É—Å–∫
      init();
    });
  </script>
</body>
</html>