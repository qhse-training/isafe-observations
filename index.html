<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-SAFE Observation Card / Карта наблюдений i-SAFE / i-SAFE Бақылау картасы</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* Общие стили / General styles / Жалпы стильдер */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #2196f3;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .language-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .language-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .lang-btn {
            padding: 8px 16px;
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .lang-btn:hover {
            background: #bbdefb;
        }
        
        .lang-btn.active {
            background: #2196f3;
            color: white;
        }
        
        .language-text {
            display: none;
        }
        
        .language-text.active {
            display: block;
        }
        
        /* Форма / Form / Форма */
        .form-section {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .required::after {
            content: " *";
            color: #f44336;
        }
        
        select, input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Чекбоксы / Checkboxes / Чекбокстар */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-grid label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .checkbox-grid label:hover {
            background: #f0f0f0;
        }
        
        .checkbox-grid input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Цветные блоки / Colored sections / Түсті блоктар */
        .red-box {
            background-color: #ffebee;
            border: 2px solid #f44336;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .yellow-box {
            background-color: #fffde7;
            border: 2px solid #ffeb3b;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .green-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .color-header {
            font-weight: bold;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .red-header {
            background-color: #f44336;
            color: white;
        }
        
        .yellow-header {
            background-color: #ffeb3b;
            color: #333;
        }
        
        .green-header {
            background-color: #4caf50;
            color: white;
        }
        
        /* Кнопка / Button / Батырма */
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        button[type="submit"] {
            background-color: #2196f3;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(33, 150, 243, 0.2);
        }
        
        button[type="submit"]:hover {
            background-color: #0b7dda;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(33, 150, 243, 0.3);
        }
        
        /* Информационные блоки / Info boxes / Ақпараттық блоктар */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }
        
        .info-box p {
            margin: 0;
            color: #1565c0;
        }
        
        /* Подсказки / Hints / Кеңестер */
        .hint {
            display: block;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }
        
        /* Адаптивность / Responsive / Бейімделгіштік */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 24px;
            }
            
            button[type="submit"] {
                width: 100%;
                padding: 15px;
            }
            
            .language-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .lang-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        
        /* Валидация / Validation / Тексеру */
        .valid {
            border-color: #4caf50 !important;
        }
        
        .invalid {
            border-color: #f44336 !important;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #ddd, transparent);
            margin: 30px 0;
        }
        
        /* Модальное окно / Modal window / Модальды терезе */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-code {
            font-size: 48px;
            font-weight: bold;
            color: #2196f3;
            margin: 20px 0;
            letter-spacing: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .modal h3 {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .modal p {
            margin: 15px 0;
            color: #666;
        }
        
        .close-modal {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .close-modal:hover {
            background-color: #0b7dda;
        }
        
        /* Загрузка / Loading / Жүктелу */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        
        .multi-language-field {
            display: none;
        }
        
        .multi-language-field.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Языковой переключатель / Language switcher / Тіл ауыстырғыш -->
        <div class="language-section">
            <h3 class="language-text kz active">Тілді таңдаңыз / Выберите язык / Select language</h3>
            <h3 class="language-text ru">Выберите язык / Тілді таңдаңыз / Select language</h3>
            <h3 class="language-text en">Select language / Выберите язык / Тілді таңдаңыз</h3>
            
            <div class="language-buttons">
                <button class="lang-btn active" data-lang="kz">Қазақша</button>
                <button class="lang-btn" data-lang="ru">Русский</button>
                <button class="lang-btn" data-lang="en">English</button>
            </div>
        </div>
        
        <header>
            <!-- Казахский заголовок -->
            <h1 class="language-text kz active">i-SAFE Бақылау картасы</h1>
            <h2 class="language-text kz active">"Бағдаршам" қауіпсіздік бақылау жүйесі</h2>
            <h3 class="language-text kz active">Бақылауларды тіркеу үшін форма</h3>
            
            <!-- Русский заголовок -->
            <h1 class="language-text ru">Карта наблюдений i-SAFE</h1>
            <h2 class="language-text ru">Система наблюдений за безопасностью "Светофор"</h2>
            <h3 class="language-text ru">Форма для регистрации наблюдений</h3>
            
            <!-- Английский заголовок -->
            <h1 class="language-text en">i-SAFE Observation Card</h1>
            <h2 class="language-text en">"Traffic Light" Safety Observation System</h2>
            <h3 class="language-text en">Observation Registration Form</h3>
        </header>
        
        <!-- Информационные блоки на разных языках -->
        <div class="info-box language-text kz active">
            <p><strong>Нұсқаулық:</strong> Барлық міндетті өрістерді толтырыңыз (* белгіленген). Бақылауды кезеңдер бойынша сипаттау үшін түсті блоктарды пайдаланыңыз. Жібергеннен кейін сіз тіркеу үшін бірегей бақылау нөмірін аласыз.</p>
        </div>
        
        <div class="info-box language-text ru">
            <p><strong>Инструкция:</strong> Заполните все обязательные поля (помеченные *). Используйте цветные блоки для описания наблюдения по этапам. После отправки вы получите уникальный номер наблюдения для регистрации.</p>
        </div>
        
        <div class="info-box language-text en">
            <p><strong>Instructions:</strong> Fill in all required fields (marked with *). Use colored sections to describe the observation by stages. After submission, you will receive a unique observation number for registration.</p>
        </div>
        
        <form id="isafe-form">
            <!-- Основная информация / Basic information / Негізгі ақпарат -->
            
            <!-- Компания наблюдателя -->
            <div class="form-section">
                <label for="observer_company" class="required language-text kz active">Бақылаушы компаниясы *</label>
                <label for="observer_company" class="required language-text ru">Компания наблюдателя *</label>
                <label for="observer_company" class="required language-text en">Observer's Company *</label>
                
                <input type="text" id="observer_company" name="observer_company" required 
                       class="language-text kz active" placeholder="Бақылаушы компаниясының атауы">
                <input type="text" id="observer_company" name="observer_company" required 
                       class="language-text ru" placeholder="Название компании наблюдателя">
                <input type="text" id="observer_company" name="observer_company" required 
                       class="language-text en" placeholder="Observer company name">
            </div>
            
            <!-- Компания наблюдения -->
            <div class="form-section">
                <label for="observation_company" class="required language-text kz active">Бақылау компаниясы *</label>
                <label for="observation_company" class="required language-text ru">Компания наблюдения *</label>
                <label for="observation_company" class="required language-text en">Observation Company *</label>
                
                <input type="text" id="observation_company" name="observation_company" required 
                       class="language-text kz active" placeholder="Бақылау жүргізілетін компанияның атауы">
                <input type="text" id="observation_company" name="observation_company" required 
                       class="language-text ru" placeholder="Название компании, где проводится наблюдение">
                <input type="text" id="observation_company" name="observation_company" required 
                       class="language-text en" placeholder="Company name where observation is conducted">
            </div>
            
            <!-- Наблюдатель -->
            <div class="form-section">
                <label for="observer_name" class="required language-text kz active">Бақылаушы *</label>
                <label for="observer_name" class="required language-text ru">Наблюдатель *</label>
                <label for="observer_name" class="required language-text en">Observer *</label>
                
                <input type="text" id="observer_name" name="observer_name" required 
                       class="language-text kz active" placeholder="Бақылаушының толық аты-жөні">
                <input type="text" id="observer_name" name="observer_name" required 
                       class="language-text ru" placeholder="ФИО наблюдателя">
                <input type="text" id="observer_name" name="observer_name" required 
                       class="language-text en" placeholder="Observer's full name">
            </div>
            
            <!-- Дата наблюдения -->
            <div class="form-section">
                <label for="observation_date" class="required language-text kz active">Бақылау күні *</label>
                <label for="observation_date" class="required language-text ru">Дата наблюдения *</label>
                <label for="observation_date" class="required language-text en">Observation Date *</label>
                
                <input type="date" id="observation_date" name="observation_date" required>
            </div>
            
            <!-- Место наблюдения -->
            <div class="form-section">
                <label for="location" class="required language-text kz active">Бақылау орны *</label>
                <label for="location" class="required language-text ru">Место наблюдения *</label>
                <label for="location" class="required language-text en">Observation Location *</label>
                
                <input type="text" id="location" name="location" required 
                       class="language-text kz active" placeholder="Цех, учаске, нысан">
                <input type="text" id="location" name="location" required 
                       class="language-text ru" placeholder="Цех, участок, объект">
                <input type="text" id="location" name="location" required 
                       class="language-text en" placeholder="Workshop, site, facility">
            </div>
            
            <!-- Тип наблюдения -->
            <div class="form-section">
                <label for="observation_type" class="required language-text kz active">Бақылау түрі *</label>
                <label for="observation_type" class="required language-text ru">Тип наблюдения *</label>
                <label for="observation_type" class="required language-text en">Observation Type *</label>
                
                <select id="observation_type" name="observation_type" required>
                    <!-- Казахский -->
                    <option value="" class="language-text kz active">Бақылау түрін таңдаңыз</option>
                    <option value="unsafe-condition" class="language-text kz active">Қауіпсіз емес жағдай</option>
                    <option value="unsafe-action" class="language-text kz active">Қауіпсіз емес әрекет</option>
                    <option value="safe-condition" class="language-text kz active">Қауіпсіз жағдай</option>
                    <option value="safe-action" class="language-text kz active">Қауіпсіз әрекет</option>
                    <option value="no-consequence" class="language-text kz active">Салдарсыз инцидент</option>
                    
                    <!-- Русский -->
                    <option value="" class="language-text ru">Выберите тип наблюдения</option>
                    <option value="unsafe-condition" class="language-text ru">Небезопасное условие</option>
                    <option value="unsafe-action" class="language-text ru">Небезопасное действие</option>
                    <option value="safe-condition" class="language-text ru">Безопасное условие</option>
                    <option value="safe-action" class="language-text ru">Безопасное действие</option>
                    <option value="no-consequence" class="language-text ru">Инцидент без последствий</option>
                    
                    <!-- Английский -->
                    <option value="" class="language-text en">Select observation type</option>
                    <option value="unsafe-condition" class="language-text en">Unsafe condition</option>
                    <option value="unsafe-action" class="language-text en">Unsafe action</option>
                    <option value="safe-condition" class="language-text en">Safe condition</option>
                    <option value="safe-action" class="language-text en">Safe action</option>
                    <option value="no-consequence" class="language-text en">Incident with no consequences</option>
                </select>
            </div>
            
            <!-- Опасные и вредные факторы -->
            <div class="form-section">
                <label class="language-text kz active"><strong>Қауіпті және зиянды факторлар (барлық сәйкес келетіндерді таңдаңыз):</strong></label>
                <label class="language-text ru"><strong>Опасные и вредные факторы (выберите все подходящие):</strong></label>
                <label class="language-text en"><strong>Hazardous and harmful factors (select all that apply):</strong></label>
                
                <span class="hint language-text kz active">Байқалған жағдайда болған барлық факторларды белгілеңіз</span>
                <span class="hint language-text ru">Отметьте все факторы, которые присутствовали в наблюдаемой ситуации</span>
                <span class="hint language-text en">Mark all factors that were present in the observed situation</span>
                
                <div class="checkbox-grid">
                    <!-- Чекбоксы будут одинаковыми для всех языков -->
                    <label><input type="checkbox" name="hazards[]" value="noise"> 
                        <span class="language-text kz active">Шуыл</span>
                        <span class="language-text ru">Шум</span>
                        <span class="language-text en">Noise</span>
                    </label>
                    <label><input type="checkbox" name="hazards[]" value="vibration">
                        <span class="language-text kz active">Діріл</span>
                        <span class="language-text ru">Вибрация</span>
                        <span class="language-text en">Vibration</span>
                    </label>
                    <label><input type="checkbox" name="hazards[]" value="radiation">
                        <span class="language-text kz active">Сәулелену</span>
                        <span class="language-text ru">Радиация</span>
                        <span class="language-text en">Radiation</span>
                    </label>
                    <label><input type="checkbox" name="hazards[]" value="temperature">
                        <span class="language-text kz active">Температура</span>
                        <span class="language-text ru">Температура</span>
                        <span class="language-text en">Temperature</span>
                    </label>
                    <label><input type="checkbox" name="hazards[]" value="lighting">
                        <span class="language-text kz active">Жарықтандыру</span>
                        <span class="language-text ru">Освещение</span>
                        <span class="language-text en">Lighting</span>
                    </label>
                    <!-- Добавьте остальные чекбоксы аналогично -->
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <!-- КРАСНЫЙ БЛОК: ОБНАРУЖЕНИЕ -->
            <div class="red-box">
                <div class="color-header red-header language-text kz active"><strong>БАҚЫЛАУ (Мен не көремін?)</strong></div>
                <div class="color-header red-header language-text ru"><strong>ОБНАРУЖЕНИЕ (Что я вижу?)</strong></div>
                <div class="color-header red-header language-text en"><strong>OBSERVATION (What do I see?)</strong></div>
                
                <div class="form-section">
                    <label for="observation_description" class="required language-text kz active">Байқалған жағдайды сипаттаңыз *</label>
                    <label for="observation_description" class="required language-text ru">Опишите ситуацию, которую вы наблюдаете *</label>
                    <label for="observation_description" class="required language-text en">Describe the situation you observe *</label>
                    
                    <span class="hint language-text kz active">Сіз байқаған жағдайды, шарттарды, әрекеттерді егжей-тегжейлі сипаттаңыз</span>
                    <span class="hint language-text ru">Подробно опишите ситуацию, условия, действия, которые вы наблюдаете</span>
                    <span class="hint language-text en">Describe in detail the situation, conditions, actions you observe</span>
                    
                    <textarea id="observation_description" name="observation_description" rows="4" required 
                        class="language-text kz active" placeholder="Мысал: Жұмысшы биіктікке шығып, карабин тартпасын анкерлік нүктеге бекітпеді. Жағдайдың егжей-тегжейлері: сақтандыру жүйесін бекітпеу биіктіктен құлауға әкелуі мүмкін."></textarea>
                    <textarea id="observation_description" name="observation_description" rows="4" required 
                        class="language-text ru" placeholder="Пример: Работник поднялся на высоту и не пристегнул карабин стропа к анкерной точке. Подробности ситуации: отсутствие фиксации страховочной системы может привести к падению с высоты."></textarea>
                    <textarea id="observation_description" name="observation_description" rows="4" required 
                        class="language-text en" placeholder="Example: Worker climbed to height and did not attach lanyard carabiner to anchor point. Situation details: lack of safety system attachment could lead to fall from height."></textarea>
                </div>
            </div>
            
            <!-- ЖЕЛТЫЙ БЛОК: РЕАКЦИЯ -->
            <div class="yellow-box">
                <div class="color-header yellow-header language-text kz active"><strong>РЕАКЦИЯ (Мен не істеймін?)</strong></div>
                <div class="color-header yellow-header language-text ru"><strong>РЕАКЦИЯ (Что я делаю?)</strong></div>
                <div class="color-header yellow-header language-text en"><strong>REACTION (What do I do?)</strong></div>
                
                <div class="form-section">
                    <label for="reaction_description" class="required language-text kz active">Бақылауға жауап ретінде сіздің әрекеттеріңізді сипаттаңыз *</label>
                    <label for="reaction_description" class="required language-text ru">Опишите ваши действия в ответ на наблюдение *</label>
                    <label for="reaction_description" class="required language-text en">Describe your actions in response to the observation *</label>
                    
                    <span class="hint language-text kz active">Бақылауға жауап ретінде қандай әрекеттер жасадыңыз немесе жоспарлап отырсыз</span>
                    <span class="hint language-text ru">Какие действия вы предприняли или планируете предпринять в ответ на наблюдение</span>
                    <span class="hint language-text en">What actions you took or plan to take in response to the observation</span>
                    
                    <textarea id="reaction_description" name="reaction_description" rows="4" required 
                        class="language-text kz active" placeholder="Мысал: Жұмысты дереу тоқтаттым. Тартпаны бекітпеу биіктіктен құлауға, ауыр жарақаттарға немесе өлімге әкелуі мүмкін екенін түсіндірдім. Сақтандыру жүйесін бекітуді талап еттім."></textarea>
                    <textarea id="reaction_description" name="reaction_description" rows="4" required 
                        class="language-text ru" placeholder="Пример: Немедленно остановил работу. Объяснил, что отсутствие фиксации стропа может привести к падению, тяжёлым травмам или летальному исходу. Потребовал пристегнуть страховочную систему."></textarea>
                    <textarea id="reaction_description" name="reaction_description" rows="4" required 
                        class="language-text en" placeholder="Example: Immediately stopped the work. Explained that not attaching lanyard could lead to fall, serious injuries or fatality. Required to attach safety system."></textarea>
                </div>
            </div>
            
            <!-- ЗЕЛЕНЫЙ БЛОК: РЕШЕНИЕ -->
            <div class="green-box">
                <div class="color-header green-header language-text kz active"><strong>ШЕШІМ (Қалай түзету керек?)</strong></div>
                <div class="color-header green-header language-text ru"><strong>РЕШЕНИЕ (Как исправить?)</strong></div>
                <div class="color-header green-header language-text en"><strong>SOLUTION (How to fix?)</strong></div>
                
                <div class="form-section">
                    <label for="solution_description" class="required language-text kz active">Мәселені шешу үшін шешім ұсыныңыз *</label>
                    <label for="solution_description" class="required language-text ru">Предложите решение для устранения проблемы *</label>
                    <label for="solution_description" class="required language-text en">Propose solution to eliminate the problem *</label>
                    
                    <span class="hint language-text kz active">Қауіпті жою немесе жағдайды жақсарту үшін нақты шаралар ұсыныңыз</span>
                    <span class="hint language-text ru">Предложите конкретные меры для устранения опасности или улучшения ситуации</span>
                    <span class="hint language-text en">Propose specific measures to eliminate hazard or improve the situation</span>
                    
                    <textarea id="solution_description" name="solution_description" rows="4" required 
                        class="language-text kz active" placeholder="Мысал: Биіктікте жұмыс жасаудың қауіпсіздік нұсқаулығын жоспарсыз өткізу. Қажет болған жағдайда — персоналды қайта оқытуды ұйымдастыру. Қосымша анкерлік нүктелерді орнату."></textarea>
                    <textarea id="solution_description" name="solution_description" rows="4" required 
                        class="language-text ru" placeholder="Пример: Провести внеплановый инструктаж по безопасному выполнению работ на высоте. При необходимости — организовать повторное обучение персонала. Установить дополнительные анкерные точки."></textarea>
                    <textarea id="solution_description" name="solution_description" rows="4" required 
                        class="language-text en" placeholder="Example: Conduct unscheduled briefing on safe work at height. If needed — organize retraining of personnel. Install additional anchor points."></textarea>
                </div>
            </div>
            
            <!-- Кнопка отправки -->
            <div class="submit-section">
                <button type="submit" id="submit-button">
                    <span class="language-text kz active">Бақылауды тіркеу</span>
                    <span class="language-text ru">Зарегистрировать наблюдение</span>
                    <span class="language-text en">Register Observation</span>
                </button>
                <div id="error-message" class="error-message" style="display: none;"></div>
            </div>
        </form>
    </div>

    <!-- Модальное окно успеха -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <h3 class="language-text kz active">Бақылау сәтті тіркелді!</h3>
            <h3 class="language-text ru">Наблюдение успешно зарегистрировано!</h3>
            <h3 class="language-text en">Observation successfully registered!</h3>
            
            <p class="language-text kz active">Сіздің бақылауыңыз i-SAFE жүйесінде сақталды.</p>
            <p class="language-text ru">Ваше наблюдение было сохранено в системе i-SAFE.</p>
            <p class="language-text en">Your observation has been saved in the i-SAFE system.</p>
            
            <div class="success-code" id="observation-number">IS-0001</div>
            
            <p class="language-text kz active">Бақылау журналында тіркеу үшін бұл нөмірді жазып алыңыз.</p>
            <p class="language-text ru">Запишите этот номер для регистрации в журнале наблюдений.</p>
            <p class="language-text en">Record this number for registration in the observation log.</p>
            
            <button class="close-modal">
                <span class="language-text kz active">Жабу</span>
                <span class="language-text ru">Закрыть</span>
                <span class="language-text en">Close</span>
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpI00DhnV2AqrVxE7eJ5nLyo7icFobLoU",
            authDomain: "i-safe-8aff1.firebaseapp.com",
            projectId: "i-safe-8aff1",
            storageBucket: "i-safe-8aff1.firebasestorage.app",
            messagingSenderId: "721183035804",
            appId: "1:721183035804:web:f81eba42fe1f272c1f3859",
            measurementId: "G-5737V4DSJJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Language management
        let currentLang = 'kz';
        
        // Language switching
        document.querySelectorAll('.lang-btn').forEach(button => {
            button.addEventListener('click', function() {
                const lang = this.getAttribute('data-lang');
                switchLanguage(lang);
            });
        });
        
        function switchLanguage(lang) {
            currentLang = lang;
            
            // Update active language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide language-specific elements
            document.querySelectorAll('.language-text').forEach(element => {
                element.classList.remove('active');
                if (element.classList.contains(lang)) {
                    element.classList.add('active');
                }
            });
            
            // Update form placeholders and values for visible fields
            updateFormForLanguage(lang);
        }
        
        function updateFormForLanguage(lang) {
            // Update select options visibility
            const select = document.getElementById('observation_type');
            const options = select.options;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.classList.contains(lang)) {
                    option.style.display = '';
                    if (i === 0 || option.value === select.value) {
                        select.selectedIndex = i;
                    }
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Update date placeholder
            const dateField = document.getElementById('observation_date');
            if (!dateField.value) {
                dateField.valueAsDate = new Date();
            }
        }
        
        // Generate unique observation number
        function generateObservationNumber() {
            const prefix = 'IS-';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date
            document.getElementById('observation_date').valueAsDate = new Date();
            
            // Initialize language
            switchLanguage('kz');
            
            // Check auth state
            checkAuthState();
        });
        
        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User authenticated:', user.email);
                    if (document.querySelector('#observer_name.language-text.kz.active').value === '') {
                        document.querySelectorAll('#observer_name').forEach(field => {
                            field.value = user.displayName || '';
                        });
                    }
                }
            });
        }
        
        // Form submission
        document.getElementById('isafe-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const observationNumber = generateObservationNumber();
            const formData = collectFormData();
            
            // Add metadata
            formData.observationNumber = observationNumber;
            formData.status = getStatusText('new');
            formData.language = currentLang;
            formData.timestamp = new Date().toISOString();
            formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            
            // Add user info if available
            const user = auth.currentUser;
            if (user) {
                formData.userId = user.uid;
                formData.userEmail = user.email;
                formData.userName = user.displayName;
            }
            
            // Show loading state
            const submitButton = document.getElementById('submit-button');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = `<span class="loading"></span>${getLoadingText()}`;
            submitButton.disabled = true;
            
            // Hide previous errors
            document.getElementById('error-message').style.display = 'none';
            
            try {
                // Save to Firestore
                await sendToFirestore(formData);
                
                // Show success modal
                document.getElementById('observation-number').textContent = observationNumber;
                document.getElementById('success-modal').style.display = 'flex';
                
                // Log for debugging
                logObservationData(formData);
                
            } catch (error) {
                console.error('Save error:', error);
                showError(getErrorText('save'));
            } finally {
                // Restore button
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
        
        // Collect form data
        function collectFormData() {
            const form = document.getElementById('isafe-form');
            const data = {
                observer_company: getActiveFieldValue('observer_company'),
                observation_company: getActiveFieldValue('observation_company'),
                observer_name: getActiveFieldValue('observer_name'),
                observation_date: document.getElementById('observation_date').value,
                location: getActiveFieldValue('location'),
                observation_type: document.getElementById('observation_type').value,
                observation_type_text: document.getElementById('observation_type').options[document.getElementById('observation_type').selectedIndex].text,
                observation_description: getActiveFieldValue('observation_description'),
                reaction_description: getActiveFieldValue('reaction_description'),
                solution_description: getActiveFieldValue('solution_description'),
                hazards: []
            };
            
            // Collect checked hazards
            const hazardCheckboxes = form.querySelectorAll('input[name="hazards[]"]:checked');
            hazardCheckboxes.forEach(checkbox => {
                data.hazards.push(checkbox.value);
            });
            
            return data;
        }
        
        // Get value from active language field
        function getActiveFieldValue(fieldId) {
            const activeField = document.querySelector(`#${fieldId}.language-text.${currentLang}.active`);
            return activeField ? activeField.value : '';
        }
        
        // Send data to Firestore
        async function sendToFirestore(data) {
            try {
                const docRef = await db.collection('observations').add(data);
                console.log('Document added with ID: ', docRef.id);
                data.firestoreId = docRef.id;
                return docRef;
            } catch (error) {
                console.error('Error adding document: ', error);
                throw error;
            }
        }
        
        // Form validation
        function validateForm() {
            const form = document.getElementById('isafe-form');
            let isValid = true;
            let firstInvalidField = null;
            
            // Reset validation styles
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
            
            // Check required fields for current language
            const requiredFields = [
                'observer_company', 'observation_company', 'observer_name',
                'location', 'observation_description', 'reaction_description',
                'solution_description'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.querySelector(`#${fieldId}.language-text.${currentLang}.active`);
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.classList.add('invalid');
                    if (!firstInvalidField) firstInvalidField = field;
                } else if (field) {
                    field.classList.add('valid');
                }
            });
            
            // Check observation date
            const dateField = document.getElementById('observation_date');
            if (!dateField.value) {
                isValid = false;
                dateField.classList.add('invalid');
                if (!firstInvalidField) firstInvalidField = dateField;
            } else {
                dateField.classList.add('valid');
            }
            
            // Check observation type
            const typeField = document.getElementById('observation_type');
            if (!typeField.value) {
                isValid = false;
                typeField.classList.add('invalid');
                if (!firstInvalidField) firstInvalidField = typeField;
            } else {
                typeField.classList.add('valid');
            }
            
            if (!isValid) {
                showError(getErrorText('required'));
                if (firstInvalidField) {
                    firstInvalidField.focus();
                }
                return false;
            }
            
            return true;
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('success-modal').style.display = 'none';
            document.getElementById('isafe-form').reset();
            document.getElementById('observation_date').valueAsDate = new Date();
            
            // Reset validation
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('valid');
            });
            
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Log observation data
        function logObservationData(data) {
            console.log('=== i-SAFE OBSERVATION DATA ===');
            console.log('OBSERVATION NUMBER:', data.observationNumber);
            console.log('LANGUAGE:', data.language);
            console.log('\nBASIC INFORMATION:');
            console.log('Observer Company:', data.observer_company);
            console.log('Observation Company:', data.observation_company);
            console.log('Observer:', data.observer_name);
            console.log('Date:', data.observation_date);
            console.log('Location:', data.location);
            console.log('Type:', data.observation_type_text);
            
            console.log('\nHAZARDS:');
            if (data.hazards && data.hazards.length > 0) {
                data.hazards.forEach(factor => console.log('-', factor));
            } else {
                console.log('- Not specified');
            }
            
            console.log('\nOBSERVATION:', data.observation_description);
            console.log('\nREACTION:', data.reaction_description);
            console.log('\nSOLUTION:', data.solution_description);
            console.log('\nSTATUS:', data.status);
            console.log('TIMESTAMP:', data.timestamp);
            console.log('================================');
        }
        
        // Dynamic validation
        document.querySelectorAll('input, textarea').forEach(field => {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            field.addEventListener('blur', function() {
                if (!this.value.trim() && this.hasAttribute('required')) {
                    this.classList.add('invalid');
                }
            });
        });
        
        // Select validation
        document.getElementById('observation_type').addEventListener('change', function() {
            if (this.value) {
                this.classList.remove('invalid');
                this.classList.add('valid');
            } else {
                this.classList.remove('valid');
            }
        });
        
        // Textarea focus effects
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('focus', function() {
                this.style.boxShadow = '0 0 0 3px rgba(33, 150, 243, 0.2)';
            });
            
            textarea.addEventListener('blur', function() {
                this.style.boxShadow = '';
            });
        });
        
        // Close modal on outside click
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('success-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Anonymous authentication
        async function signInAnonymously() {
            try {
                await auth.signInAnonymously();
                console.log('Anonymous auth successful');
            } catch (error) {
                console.error('Anonymous auth error:', error);
            }
        }
        
        // Auto anonymous auth
        signInAnonymously();
        
        // Language-specific text functions
        function getLoadingText() {
            const texts = {
                'kz': 'Жіберілуде...',
                'ru': 'Отправка...',
                'en': 'Submitting...'
            };
            return texts[currentLang] || texts['en'];
        }
        
        function getErrorText(type) {
            const errors = {
                'required': {
                    'kz': 'Барлық міндетті өрістерді толтырыңыз (* белгіленген)',
                    'ru': 'Пожалуйста, заполните все обязательные поля (помеченные *)',
                    'en': 'Please fill in all required fields (marked with *)'
                },
                'save': {
                    'kz': 'Деректерді сақтау кезінде қате орын алды. Өтінеміз, қайталап көріңіз.',
                    'ru': 'Ошибка при сохранении данных. Пожалуйста, попробуйте еще раз.',
                    'en': 'Error saving data. Please try again.'
                }
            };
            return errors[type][currentLang] || errors[type]['en'];
        }
        
        function getStatusText(status) {
            const statuses = {
                'new': {
                    'kz': 'Жаңа',
                    'ru': 'Новое',
                    'en': 'New'
                }
            };
            return statuses[status][currentLang] || statuses[status]['en'];
        }
        
        // Initialize modal close button
        document.querySelector('.close-modal').addEventListener('click', closeModal);
    </script>
</body>
</html>