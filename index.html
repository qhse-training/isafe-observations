<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта наблюдений i-SAFE</title>
    
    <!-- Подключение Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #2196f3;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        h2 {
            color: #333;
            margin-bottom: 5px;
            font-size: 22px;
        }
        
        h3 {
            color: #666;
            font-weight: normal;
            font-size: 18px;
        }
        
        /* Стили для формы */
        .form-section {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .required::after {
            content: " *";
            color: #f44336;
        }
        
        select, input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Сетка для чекбоксов */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-grid label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .checkbox-grid label:hover {
            background: #f0f0f0;
        }
        
        .checkbox-grid input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Цветные боксы для этапов наблюдения */
        .red-box {
            background-color: #ffebee;
            border: 2px solid #f44336;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            position: relative;
        }
        
        .yellow-box {
            background-color: #fffde7;
            border: 2px solid #ffeb3b;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            position: relative;
        }
        
        .green-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            position: relative;
        }
        
        .color-header {
            font-weight: bold;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .red-header {
            background-color: #f44336;
            color: white;
        }
        
        .yellow-header {
            background-color: #ffeb3b;
            color: #333;
        }
        
        .green-header {
            background-color: #4caf50;
            color: white;
        }
        
        /* Стили для кнопки */
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        button[type="submit"] {
            background-color: #2196f3;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(33, 150, 243, 0.2);
        }
        
        button[type="submit"]:hover {
            background-color: #0b7dda;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(33, 150, 243, 0.3);
        }
        
        button[type="submit"]:active {
            transform: translateY(0);
        }
        
        /* Информационные блоки */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }
        
        .info-box p {
            margin: 0;
            color: #1565c0;
        }
        
        /* Подсказки */
        .hint {
            display: block;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            button[type="submit"] {
                width: 100%;
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .color-header {
                font-size: 16px;
                padding: 10px;
            }
        }
        
        /* Стили для статуса валидации */
        .valid {
            border-color: #4caf50 !important;
        }
        
        .invalid {
            border-color: #f44336 !important;
        }
        
        /* Разделитель */
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #ddd, transparent);
            margin: 30px 0;
        }
        
        /* Стили для модального окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-code {
            font-size: 48px;
            font-weight: bold;
            color: #2196f3;
            margin: 20px 0;
            letter-spacing: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .modal h3 {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .modal p {
            margin: 15px 0;
            color: #666;
        }
        
        .close-modal {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .close-modal:hover {
            background-color: #0b7dda;
        }
        
        /* Стили для состояния загрузки */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Карта наблюдений i-SAFE</h1>
            <h2>Система наблюдений за безопасностью "Светофор"</h2>
            <h3>Форма для регистрации наблюдений</h3>
        </header>
        
        <div class="info-box">
            <p><strong>Инструкция:</strong> Заполните все обязательные поля (помеченные *). Используйте цветные блоки для описания наблюдения по этапам. После отправки вы получите уникальный номер наблюдения для регистрации.</p>
        </div>
        
        <form id="isafe-form">
            <!-- Основная информация -->
            <div class="form-section">
                <label for="observer_company" class="required">Компания наблюдателя *</label>
                <input type="text" id="observer_company" name="observer_company" required placeholder="Название компании наблюдателя">
            </div>
            
            <div class="form-section">
                <label for="observation_company" class="required">Компания наблюдения *</label>
                <input type="text" id="observation_company" name="observation_company" required placeholder="Название компании, где проводится наблюдение">
            </div>
            
            <div class="form-section">
                <label for="observer_name" class="required">Наблюдатель *</label>
                <input type="text" id="observer_name" name="observer_name" required placeholder="ФИО наблюдателя">
            </div>
            
            <div class="form-section">
                <label for="observation_date" class="required">Дата наблюдения *</label>
                <input type="date" id="observation_date" name="observation_date" required>
            </div>
            
            <div class="form-section">
                <label for="location" class="required">Место наблюдения *</label>
                <input type="text" id="location" name="location" required placeholder="Цех, участок, объект">
            </div>
            
            <!-- Тип наблюдения -->
            <div class="form-section">
                <label for="observation_type" class="required">Тип наблюдения *</label>
                <select id="observation_type" name="observation_type" required>
                    <option value="">Выберите тип наблюдения</option>
                    <option value="unsafe-condition">Небезопасное условие</option>
                    <option value="unsafe-action">Небезопасное действие</option>
                    <option value="safe-condition">Безопасное условие</option>
                    <option value="safe-action">Безопасное действие</option>
                    <option value="no-consequence">Инцидент без последствий</option>
                </select>
            </div>
            
            <!-- Опасные и вредные факторы -->
            <div class="form-section">
                <label><strong>Опасные и вредные факторы (выберите все подходящие):</strong></label>
                <span class="hint">Отметьте все факторы, которые присутствовали в наблюдаемой ситуации</span>
                <div class="checkbox-grid">
                    <label><input type="checkbox" name="hazards[]" value="noise"> Шум</label>
                    <label><input type="checkbox" name="hazards[]" value="vibration"> Вибрация</label>
                    <label><input type="checkbox" name="hazards[]" value="radiation"> Радиация</label>
                    <label><input type="checkbox" name="hazards[]" value="temperature"> Температура</label>
                    <label><input type="checkbox" name="hazards[]" value="lighting"> Освещение</label>
                    <label><input type="checkbox" name="hazards[]" value="extreme_weather"> Работа в экстремальную погоду</label>
                    <label><input type="checkbox" name="hazards[]" value="height"> Работа на высоте</label>
                    <label><input type="checkbox" name="hazards[]" value="falling_objects"> Падающие предметы</label>
                    <label><input type="checkbox" name="hazards[]" value="slip_trip"> Подскальзывание / спотыкание</label>
                    <label><input type="checkbox" name="hazards[]" value="heavy_equipment"> Тяжёлая техника</label>
                    <label><input type="checkbox" name="hazards[]" value="driving"> Вождение (транспорт)</label>
                    <label><input type="checkbox" name="hazards[]" value="hand_tools"> Ручные и переносные инструменты</label>
                    <label><input type="checkbox" name="hazards[]" value="high_pressure"> Высокое давление</label>
                    <label><input type="checkbox" name="hazards[]" value="rotating_parts"> Крутящиеся и вращающиеся части</label>
                    <label><input type="checkbox" name="hazards[]" value="flying_particles"> Летящие частицы</label>
                    <label><input type="checkbox" name="hazards[]" value="electrical"> Электробезопасность</label>
                    <label><input type="checkbox" name="hazards[]" value="lifting"> Грузоподъёмные работы</label>
                    <label><input type="checkbox" name="hazards[]" value="chemical"> Химическая опасность</label>
                    <label><input type="checkbox" name="hazards[]" value="biological"> Биологическая опасность</label>
                    <label><input type="checkbox" name="hazards[]" value="psychological"> Психологический фактор</label>
                    <label><input type="checkbox" name="hazards[]" value="ergonomics"> Эргономика</label>
                    <label><input type="checkbox" name="hazards[]" value="substances"> Психоактивные вещества</label>
                    <label><input type="checkbox" name="hazards[]" value="manual_handling"> Ручное перемещение грузов</label>
                    <label><input type="checkbox" name="hazards[]" value="vulnerable_workers"> Уязвимые работники</label>
                    <label><input type="checkbox" name="hazards[]" value="confined_space"> Замкнутое пространство</label>
                    <label><input type="checkbox" name="hazards[]" value="hot_work"> Огневые работы</label>
                    <label><input type="checkbox" name="hazards[]" value="excavation"> Земляные работы</label>
                    <label><input type="checkbox" name="hazards[]" value="loto"> Блокировка/Маркировка (LOTO)</label>
                    <label><input type="checkbox" name="hazards[]" value="fire_safety"> Пожарная безопасность</label>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <!-- Красный блок: ОБНАРУЖЕНИЕ -->
            <div class="red-box">
                <div class="color-header red-header">
                    <strong>ОБНАРУЖЕНИЕ (Что я вижу?)</strong>
                </div>
                <div class="form-section">
                    <label for="observation_description" class="required">Опишите ситуацию, которую вы наблюдаете *</label>
                    <span class="hint">Подробно опишите ситуацию, условия, действия, которые вы наблюдаете</span>
                    <textarea id="observation_description" name="observation_description" rows="4" required 
                              placeholder="Пример: Работник поднялся на высоту и не пристегнул карабин стропа к анкерной точке. Подробности ситуации: отсутствие фиксации страховочной системы может привести к падению с высоты."></textarea>
                </div>
            </div>
            
            <!-- Желтый блок: РЕАКЦИЯ -->
            <div class="yellow-box">
                <div class="color-header yellow-header">
                    <strong>РЕАКЦИЯ (Что я делаю?)</strong>
                </div>
                <div class="form-section">
                    <label for="reaction_description" class="required">Опишите ваши действия в ответ на наблюдение *</label>
                    <span class="hint">Какие действия вы предприняли или планируете предпринять в ответ на наблюдение</span>
                    <textarea id="reaction_description" name="reaction_description" rows="4" required 
                              placeholder="Пример: Немедленно остановил работу. Объяснил, что отсутствие фиксации стропа может привести к падению, тяжёлым травмам или летальному исходу. Потребовал пристегнуть страховочную систему."></textarea>
                </div>
            </div>
            
            <!-- Зеленый блок: РЕШЕНИЕ -->
            <div class="green-box">
                <div class="color-header green-header">
                    <strong>РЕШЕНИЕ (Как исправить?)</strong>
                </div>
                <div class="form-section">
                    <label for="solution_description" class="required">Предложите решение для устранения проблемы *</label>
                    <span class="hint">Предложите конкретные меры для устранения опасности или улучшения ситуации</span>
                    <textarea id="solution_description" name="solution_description" rows="4" required 
                              placeholder="Пример: Провести внеплановый инструктаж по безопасному выполнению работ на высоте. При необходимости — организовать повторное обучение персонала. Установить дополнительные анкерные точки."></textarea>
                </div>
            </div>
            
            <!-- Кнопка отправки -->
            <div class="submit-section">
                <button type="submit" id="submit-button">Зарегистрировать наблюдение</button>
                <div id="error-message" class="error-message" style="display: none;"></div>
            </div>
        </form>
    </div>

    <!-- Модальное окно с номером наблюдения -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <h3>Наблюдение успешно зарегистрировано!</h3>
            <p>Ваше наблюдение было сохранено в системе i-SAFE.</p>
            <div class="success-code" id="observation-number">IS-0001</div>
            <p>Запишите этот номер для регистрации в журнале наблюдений.</p>
            <button class="close-modal" onclick="closeModal()">Закрыть</button>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCpI00DhnV2AqrVxE7eJ5nLyo7icFobLoU",
            authDomain: "i-safe-8aff1.firebaseapp.com",
            projectId: "i-safe-8aff1",
            storageBucket: "i-safe-8aff1.firebasestorage.app",
            messagingSenderId: "721183035804",
            appId: "1:721183035804:web:f81eba42fe1f272c1f3859",
            measurementId: "G-5737V4DSJJ"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Генерация уникального номера наблюдения
        function generateObservationNumber() {
            const prefix = 'IS-';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // Инициализация формы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты по умолчанию
            document.getElementById('observation_date').valueAsDate = new Date();
            
            // Проверка авторизации
            checkAuthState();
        });
        
        // Проверка состояния авторизации
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('Пользователь авторизован:', user.email);
                    // Можно добавить информацию о пользователе в форму
                    if (document.getElementById('observer_name').value === '') {
                        document.getElementById('observer_name').value = user.displayName || '';
                    }
                } else {
                    console.log('Пользователь не авторизован');
                    // Можно предложить авторизацию или оставить анонимный доступ
                }
            });
        }
        
        // Обработка отправки формы
        document.getElementById('isafe-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Валидация формы
            if (!validateForm()) {
                return;
            }
            
            // Генерация номера наблюдения
            const observationNumber = generateObservationNumber();
            
            // Сбор данных формы
            const formData = collectFormData();
            formData.observationNumber = observationNumber;
            formData.status = 'Новое';
            formData.timestamp = new Date().toISOString();
            formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            
            // Получаем информацию о текущем пользователе
            const user = auth.currentUser;
            if (user) {
                formData.userId = user.uid;
                formData.userEmail = user.email;
                formData.userName = user.displayName;
            }
            
            // Показываем индикатор загрузки
            const submitButton = document.getElementById('submit-button');
            const originalText = submitButton.textContent;
            submitButton.innerHTML = '<span class="loading"></span>Отправка...';
            submitButton.disabled = true;
            
            // Скрываем предыдущие ошибки
            document.getElementById('error-message').style.display = 'none';
            
            try {
                // Отправляем данные в Firestore
                await sendToFirestore(formData);
                
                // Показываем модальное окно с номером
                document.getElementById('observation-number').textContent = observationNumber;
                document.getElementById('success-modal').style.display = 'flex';
                
                // Запись в консоль для отладки
                logObservationData(formData);
                
            } catch (error) {
                // Показываем ошибку
                console.error('Ошибка при сохранении:', error);
                showError('Ошибка при сохранении данных. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Восстанавливаем кнопку
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
        
        // Сбор данных формы
        function collectFormData() {
            const form = document.getElementById('isafe-form');
            const formData = new FormData(form);
            const data = {
                observer_company: formData.get('observer_company'),
                observation_company: formData.get('observation_company'),
                observer_name: formData.get('observer_name'),
                observation_date: formData.get('observation_date'),
                location: formData.get('location'),
                observation_type: document.getElementById('observation_type').value,
                observation_type_text: document.getElementById('observation_type').options[document.getElementById('observation_type').selectedIndex].text,
                observation_description: formData.get('observation_description'),
                reaction_description: formData.get('reaction_description'),
                solution_description: formData.get('solution_description'),
                hazards: []
            };
            
            // Сбор выбранных опасных факторов
            const hazardCheckboxes = form.querySelectorAll('input[name="hazards[]"]:checked');
            hazardCheckboxes.forEach(checkbox => {
                data.hazards.push(checkbox.value);
            });
            
            return data;
        }
        
        // Отправка данных в Firestore
        async function sendToFirestore(data) {
            try {
                const docRef = await db.collection('observations').add(data);
                console.log('Документ добавлен с ID: ', docRef.id);
                data.firestoreId = docRef.id;
                return docRef;
            } catch (error) {
                console.error('Ошибка при добавлении документа: ', error);
                throw error;
            }
        }
        
        // Валидация формы
        function validateForm() {
            const form = document.getElementById('isafe-form');
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            let firstInvalidField = null;
            
            // Сброс предыдущих стилей валидации
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
            
            // Проверка обязательных полей
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('invalid');
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                } else {
                    field.classList.add('valid');
                }
            });
            
            // Проверка типа наблюдения
            const observationType = document.getElementById('observation_type');
            if (observationType.value === '') {
                isValid = false;
                observationType.classList.add('invalid');
                if (!firstInvalidField) firstInvalidField = observationType;
            }
            
            if (!isValid) {
                showError('Пожалуйста, заполните все обязательные поля (помеченные *)');
                if (firstInvalidField) {
                    firstInvalidField.focus();
                }
                return false;
            }
            
            return true;
        }
        
        // Показать сообщение об ошибке
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Автоматически скрыть через 5 секунд
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Закрытие модального окна
        function closeModal() {
            document.getElementById('success-modal').style.display = 'none';
            // Сброс формы
            document.getElementById('isafe-form').reset();
            document.getElementById('observation_date').valueAsDate = new Date();
            
            // Сброс стилей валидации
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('valid');
            });
            
            // Скрыть сообщение об ошибке
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Логирование данных для отладки
        function logObservationData(data) {
            console.log('=== ДАННЫЕ НАБЛЮДЕНИЯ i-SAFE ===');
            console.log('НОМЕР НАБЛЮДЕНИЯ:', data.observationNumber);
            console.log('Firestore ID:', data.firestoreId || 'не сохранено');
            console.log('\nОСНОВНАЯ ИНФОРМАЦИЯ:');
            console.log('Компания наблюдателя:', data.observer_company);
            console.log('Компания наблюдения:', data.observation_company);
            console.log('Наблюдатель:', data.observer_name);
            console.log('Дата:', data.observation_date);
            console.log('Место:', data.location);
            console.log('Тип наблюдения:', data.observation_type_text);
            
            console.log('\nОПАСНЫЕ ФАКТОРЫ:');
            if (data.hazards && data.hazards.length > 0) {
                data.hazards.forEach(factor => {
                    console.log('-', factor);
                });
            } else {
                console.log('- Не указаны');
            }
            
            console.log('\nОБНАРУЖЕНИЕ:');
            console.log(data.observation_description);
            
            console.log('\nРЕАКЦИЯ:');
            console.log(data.reaction_description);
            
            console.log('\nРЕШЕНИЕ:');
            console.log(data.solution_description);
            
            console.log('\nСТАТУС:', data.status);
            console.log('ВРЕМЯ СОЗДАНИЯ:', data.timestamp);
            console.log('=================================');
        }
        
        // Динамическая валидация при вводе
        const requiredFields = document.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            field.addEventListener('blur', function() {
                if (!this.value.trim() && this.hasAttribute('required')) {
                    this.classList.add('invalid');
                }
            });
        });
        
        // Валидация типа наблюдения
        document.getElementById('observation_type').addEventListener('change', function() {
            if (this.value) {
                this.classList.remove('invalid');
                this.classList.add('valid');
            } else {
                this.classList.remove('valid');
            }
        });
        
        // Подсказка для текстовых полей
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('focus', function() {
                this.style.boxShadow = '0 0 0 3px rgba(33, 150, 243, 0.2)';
            });
            
            textarea.addEventListener('blur', function() {
                this.style.boxShadow = '';
            });
        });
        
        // Закрытие модального окна по клику вне его
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('success-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Анонимная авторизация для возможности работы с Firestore
        async function signInAnonymously() {
            try {
                await auth.signInAnonymously();
                console.log('Анонимная авторизация успешна');
            } catch (error) {
                console.error('Ошибка анонимной авторизации:', error);
            }
        }
        
        // Автоматическая анонимная авторизация при загрузке
        signInAnonymously();
    </script>
</body>
</html>